---
title: 'Unicode'
img: new-york.jpg # Add image post (optional)
date: 2018-08-22 22:20:00

tag: [unicode, javascript]
---

# Unicode

Unicode æ˜¯ä¸€ä¸ªå­—ç¬¦é›†ï¼Œå®ƒæŠŠç›®å‰ä¸–ç•Œä¸Šæ‰€æœ‰å­—ç¬¦åŒ…å«åœ¨å†…äº†ã€‚æ¯ä¸ªç¬¦å·éƒ½ä¸ä¸€ä¸ªç§°ä¸ºä»£ç ç‚¹ï¼ˆ`Code Point`ï¼‰çš„åå…­è¿›åˆ¶æ•°å¯¹åº”ï¼Œä»£ç ç‚¹é€šå¸¸æœ‰ä¸€ä¸ª`U+`å‰ç¼€ï¼Œä¾‹å¦‚ï¼š

```js
U+0041 =>  A
U+0061 =>   a
U+2603 =>   â˜ƒ
U+1F4A9Â  => ğŸ’©
```

Code Point çš„å–å€¼èŒƒå›´æ˜¯`U+0000`~`U+10FFFF`ï¼Œå¤§çº¦æœ‰ 110 ä¸‡ä¸ªã€‚ ä¸ºäº†å¥½ç»„ç»‡ï¼Œæ‰€æœ‰`Code Point`è¢«åˆ†ä¸ºäº† 17 ä¸ª`Plane`ï¼Œæ¯ä¸ª`Plane`ä¸­å¤§çº¦åŒ…å« 65K ä¸ª`Code Point`ã€‚ è§[ç»´åŸºç™¾ç§‘](https://en.wikipedia.org/wiki/Unicode)

![](/images/Unicode/Unicode-Panel.png)

å…¶ä¸­ç¬¬ä¸€ä¸ª`Plane`ï¼ˆU+0000~ U+FFFFï¼‰è¢«ç§°ä¸º`BMP`ï¼ˆ`Basic Multilingual Plane`ï¼‰,åŒ…å«äº†å‡ ä¹æ‰€æœ‰çš„å¸¸ç”¨å­—ç¬¦ã€‚

å‰©ä¸‹çš„å…¶ä»–`Plane`ï¼ˆU+10000~ U+10FFFFï¼‰è¢«ç§°ä¸º`supplementary planesï¼ˆSMPï¼‰`æˆ–è€… Â `astral planes`ï¼Œå¯¹åº”çš„å­—ç¬¦é€šå¸¸ç§°ä¸º`astral symbols`ã€‚

å¦ï¼š æ±‰å­—çš„ Unicode ç ç‚¹èŒƒå›´[å¯ä»¥å‚ç…§è¿™é‡Œ](http://www.qqxiuzi.cn/zh/hanzi-unicode-bianma.php)

# JavaScript ä¸­çš„å­—ç¬¦è¡¨ç¤º

## è½¬ä¹‰

åœ¨ js ä¸­çš„å­—ç¬¦ä¸²ä¸­å¯ä»¥ä½¿ç”¨`\u`æ¥è½¬ä¹‰å„ç§ Unicode å­—ç¬¦ï¼š

```js
'\u0041'; // A
'\u0061'; // a
'\u4E25'; // ä¸¥
'\u2603'; // â˜ƒ
```

å¦‚æœæ˜¯`astral symbols`ï¼Œåœ¨ ES5 ä¸­æ˜¯ä¸èƒ½è¢«æ­£å¸¸è½¬ä¹‰çš„ï¼š

```js
á½Š9; // á½Š9
```

é™¤éä½¿ç”¨ä»–åœ¨ js å†…éƒ¨è¡¨ç¤ºçš„`<Hï¼ŒL>`å½¢å¼(ä¸‹èŠ‚ä¼šæè¿°)ï¼š

```js
'\uD83D\uDCA9'; // ğŸ’©    code point: U+1F4A9
```

ä¸è¿‡åœ¨ ES6 å¯ä»¥å°†ä»£ç ç‚¹æ”¾åˆ°`{}`ä¸­,ä¹Ÿèƒ½æ­£å¸¸è½¬ä¹‰äº†ï¼š

```js
\u{1F4A9}  // ğŸ’©
```

## å†…éƒ¨è¡¨ç¤º

> Internally, JavaScript represents astral symbols asÂ surrogate pairs, andÂ it exposes the separate surrogate halves as separate â€œcharactersâ€. If you represent the symbols using nothing but ECMAScript 5-compatible escape sequences, youâ€™ll see that two escapes are needed for each astral symbol. This is confusing, because humans generally think in terms ofÂ Unicode symbolsÂ orÂ graphemesÂ instead.

> å¤§æ„ï¼š å¯¹äº astral symbolsï¼ŒJavaScript å®é™…ä¸ŠæŠŠå®ƒæ‹†æˆäº†ä¸Šä¸‹ä¸¤åŠï¼ˆHã€Lï¼‰åˆ†åˆ«æ¥è¡¨ç¤ºï¼ŒH å’Œ L éƒ½æ˜¯ 2 ä¸ªå­—èŠ‚ã€‚

Hã€L çš„è®¡ç®—å…¬å¼ï¼š

```js
H = Math.floor((C - 0x10000) / 0x400) + 0xd800;
L = ((C - 0x10000) % 0x400) + 0xdc00;

// result is : <H,L>
```

å› ä¸º astral symbols çš„èŒƒå›´æ˜¯`U+010000 â†’ U+10FFFF`ï¼Œæ•…

`H`çš„èŒƒå›´å°±æ˜¯ `0xD800`~`0xDBFF`ï¼Œ ä¸€å…± 2^10 ä¸ªå­—ç¬¦
`L`çš„èŒƒå›´å°±æ˜¯ `0xDC00` ~ `0xDFFF`ï¼Œä¸€å…± 2^10 ä¸ªå­—ç¬¦

å› ä¸º`astral symbols`çš„èŒƒå›´æ˜¯`U+10000`~`U+10FFFF`,ä¸€å…± 2^20 ä¸ªå­—ç¬¦ï¼Œæ‰€ä»¥ H å’Œ L ç»“åˆèµ·æ¥ï¼Œæ­£å·§èƒ½è¡¨ç¤ºå…¨éƒ¨çš„`astral symbols`ã€‚

ä¾‹å¦‚ "ğŸ’©"(0x1F4A9)ï¼Œåœ¨ javascript ä¸­å®é™…ä¸Šä½¿ç”¨çš„ 0xD83D å’Œ 0xDCA9 æ¥è¡¨ç¤ºçš„ã€‚

**å®é™…ä¸Šä¸Šè¿°æ–¹æ³•å°±æ˜¯ UTF-16 ç¼–ç çš„æ€è·¯ï¼Œå…·ä½“å‚è§[é˜®ä¸€å³°çš„åˆ†äº«](http://www.ruanyifeng.com/blog/2014/12/unicode.html)**

å¦å¤–ï¼Œå¯¹äº BMP åŒºé—´çš„ç ç‚¹ï¼Œjs ä¸­ä¼šç›´æ¥å°†ç ç‚¹è½¬ä¸ºåå…­è¿›åˆ¶å½¢å¼ï¼š

```js
U+4E25  => 0x4E25
```

# JavaScript ä¸­çš„å­—ç¬¦ä¸²æ“ä½œ

## è®¡ç®— Unicode å­—ç¬¦é•¿åº¦

è¿™ä¸ªé•¿åº¦æŒ‡çš„æ˜¯**äººçœ¼**ç›´è§‚çš„é•¿åº¦ï¼ˆå³ Unicode å­—ç¬¦ä¸ªæ•°ï¼‰ã€‚

å¯ä»¥åˆ©ç”¨ Hã€L çš„å–å€¼èŒƒå›´æ„é€ æ­£åˆ™åŒ¹é…`astral symbols`ï¼ŒæŠŠä»–ä»¬æ›¿æ¢æˆæ™®é€šå­—ç¬¦ï¼Œç„¶åè®¡ç®—é•¿åº¦ï¼š

```js
var regexAstralSymbols = /[\uD800-\uDBFF][\uDC00-\uDFFF]/g;

// å°†æ¯ä¸ªastral symbolsè£…æ¢æˆä¸€ä¸ªBMPå­—ç¬¦ï¼Œç„¶åç›´æ¥è®¡ç®—æœ€ç»ˆç»“æœçš„lengthå³å¯ã€‚
function countSymbols(string) {
  return string.replace(regexAstralSymbols, '_').length;
}

countSymbols('ğŸ˜„ä½ å¥½é˜¿ï¼ŒtestÂ©'); // 10
```

å¦‚æœä½¿ç”¨ ES6 çš„è¯­æ³•ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨`Array.from`æˆ–è€…æ‰©æ•£è¿ç®—ç¬¦`...`(äºŒè€…æœ¬è´¨ä¸Šæ˜¯åŒä¸€ä¸ªä¸œè¥¿)ï¼š

```
function countSymbols2(string) {
	return Array.from(string).length;
}

countSymbols2("ğŸ˜„ä½ å¥½é˜¿ï¼ŒtestÂ©") // 10

function countSymbols3(string) {
	return [...string].length;
}

countSymbols3("ğŸ˜„ä½ å¥½é˜¿ï¼ŒtestÂ©") // 10
```

## ç¿»è½¬å­—ç¬¦ä¸²

1.  **æ­¤å‰çš„åšæ³•**

    ```js
    function reverse(string) {
      return string
        .split('')
        .reverse()
        .join('');
    }

    reverse('abc'); // 'cba'
    ```

    æ­¤æ–¹æ³•åœ¨å¤„ç†`astral symbols`ä¼šå‡ºç°é—®é¢˜ï¼š

    ```js
    reverse('ğŸ’©'); // 'ï¿½ï¿½'
    ```

2.  **ES6 æä¾›äº†å¥½ä¸€ç‚¹çš„è§£å†³æ–¹æ³•**

    ```js
    function reverse2(string) {
      return Array.from(string)
        .reverse()
        .join('');
    }

    reverse2('ğŸ’©çé¦™'); // "é¦™çğŸ’©"
    ```

3.  æœ‰ä¸€ä¸ªå¼€æºåº“ä¸“é—¨é’ˆå¯¹å­—ç¬¦ä¸²åè½¬åšäº†å¤„ç†ï¼š [esrever](https://github.com/mathiasbynens/esrever)

## å…¶ä»–å­—ç¬¦ä¸²å¤„ç†æ–¹æ³•åœ¨é¢å¯¹ Unicode æ—¶çš„é—®é¢˜

1.  `fromCharcode` - å¯ä»¥åŸºäº`code point`åˆ›å»ºå­—ç¬¦ä¸²ï¼Œä½†åªèƒ½å¤„ç†ä½äº BMP åŒºé—´(`U+0000`~`U+FFFF`)çš„ unicode å­—ç¬¦,ä¼šç›´æ¥æˆªæ–­`astral symbols`çš„é«˜ä½å­—èŠ‚ã€‚

    ```js
    String.fromCharCode(0x0041); // A
    String.fromCharCode(0x1f4a9); // 'ï’©'  U+F4A9, not U+1F4A9
    ```

    è§£å†³çš„åŠæ³•æ˜¯æ ¹æ®ä¸Šé¢è®¡ç®— Hã€L çš„å…¬å¼å…ˆè®¡ç®—å‡º Hã€L,ç„¶åå†ä¼ å…¥`String.fromCharCode`ï¼š

    ```js
    0x1F4A9 => H: D83D  L: DCA9

    String.fromCharCode(0xd83d,0xdca9) // "ğŸ’©"
    ```

    æˆ–è€…ç›´æ¥ä½¿ç”¨ ES6 çš„`fromCodePoint`ï¼š

    ```js
    String.fromCodePoint(0x1f4a9); // "ğŸ’©"
    ```

2.  `String.prototype.charAt(position)`å¯¹äº`astral symbols`è·å–çš„åªæ˜¯ H æˆ–è€… L çš„éƒ¨åˆ†ï¼š

    ```js
    'ğŸ’©'.charAt(0); // '\uD83D'
    'ğŸ’©'.charAt(1); // '\uDCA9'
    ```

3.  `String.prototype.charCodeAt(position)`ï¼Œä¸`charAt`ç±»ä¼¼ï¼Œå¯¹äº`astral symbols`è·å–çš„åªæ˜¯ H æˆ–è€… L çš„æ•°å­—å½¢å¼ï¼š

    ```js
    'ğŸ’©'.charCodeAt(0); // 0xD83D
    'ğŸ’©'.charCodeAt(1); // 0xDCA9
    ```

    å–è€Œä»£ä¹‹åº”è¯¥ä½¿ç”¨`codePointAt`:

    ```js
    'ğŸ’©'.codePointAt(0); // 0x1F4A9
    ```

# æ­£åˆ™è¡¨è¾¾å¼ä¸ Unicode

## åŒ¹é… BMP åŒºé—´å­—ç¬¦

å¯ä»¥ç›´æ¥ä½¿ç”¨è½¬ä¹‰å½¢å¼çš„æ­£åˆ™æ¥åŒ¹é… BMP åŒºé—´å­—ç¬¦ï¼š

```js
/\u0061/.test('a'); // true
```

## åŒ¹é… astral symbol

ç›´æ¥ç”¨å¯¹åº”çš„ä»£ç ç‚¹æ„æˆçš„æ­£åˆ™æ˜¯ä¸èƒ½åŒ¹é…`astral symbol`çš„ï¼š

```js
/\u{1F4A9}/.test('ğŸ’©'); // false
```

ç”±äº`astral symbol`åœ¨ js ä¸­æ˜¯ç”± H/L åˆ†å¼€è¡¨ç¤ºï¼Œ`.`ç‚¹å·ä¹Ÿä¸èƒ½åŒ¹é…`astral symbol`ï¼š

```js
/foo.bar/.test('fooğŸ’©bar') // fasle
/^.$/.test('ğŸ’©') // false
```

å¦‚æœåªä»ä»£ç ç‚¹çš„è§’åº¦å‡ºå‘ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªå®Œæ•´çš„åŒ¹é… Unicode çš„æ­£åˆ™ï¼ˆä¹‹åä¼šä»‹ç» ES6 æ–°å¢çš„`u`ä¿®é¥°ç¬¦ï¼‰ï¼š

```js
// match BMPã€astral symbol H/L pairã€ lone H/L
const unicodeReg = /[\0-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]/;

unicodeReg.test('ğŸ’©'); // true
```

å¦‚æœæ³¨æ„åˆ°ä¸Šé¢æ­£åˆ™çš„ç¬¬ä¸€ä¸ªéƒ¨åˆ†æ˜¯åˆ†ä¸ºäº†ä¸¤æ®µï¼š `\0-\uD7FF`å’Œ`\uE000-\uFFFF`ï¼Œè¿™æ˜¯å› ä¸º`BMP`å†…çš„`U+D800`åˆ°`U+DFFF`æ˜¯ä¸€ä¸ªç©ºæ®µï¼ŒæœŸé—´çš„ä»£ç ç‚¹æ²¡æœ‰æ˜ å°„åˆ°ä»»ä½•å­—ç¬¦ã€‚å®é™…ä¸Š`UTF-16`ç¼–ç æ­£æ˜¯åˆ©ç”¨çš„è¿™ä¸ªç©ºæ®µæ¥æ˜ å°„`astral symbols`çš„ã€‚

## èŒƒå›´åŒ¹é…ä¸ Unicode

æ­£åˆ™è¡¨è¾¾å¼ä¸­ç»å¸¸ä¼šç”¨åˆ°èŒƒå›´åŒ¹é…ï¼š

```js
/[a-c]/.test('a') // true
/[a-c]/.test('b') // true
/[a-c]/.test('c') // true
```

ä½†æ˜¯è¿™ç§æ–¹æ³•åœ¨é‡åˆ° Unicode å­—ç¬¦æ—¶å¯èƒ½ä¼šå‡ºé—®é¢˜ï¼š

```js
/[ğŸ’©-ğŸ’«]/;
// Uncaught SyntaxError: Invalid regular expression: /[ğŸ’©-ğŸ’«]/: Range out of order in character class
```

å› ä¸ºä¸Šé¢çš„æ­£åˆ™è¡¨è¾¾å¼ç­‰ä»·äºï¼š

```js
/[\uD83D\uDCA9-\uD83D\uDCAB]/;
```

`-`å‰ååˆ†åˆ«æ˜¯ä¸¤ä¸ªå­—ç¬¦çš„ Hã€L éƒ¨åˆ†ï¼Œè¿™ä¸ªè¡¨è¾¾å¼å…¶å®æ˜¯åœ¨åŒ¹é…ï¼š

- `\uD83D` ä¸€ä¸ª H
- `\uDCA9-\uD83D` è¿™é‡Œæ˜¯å‡ºé”™çš„åŸå› ï¼Œå› ä¸ºå·¦è¾¹çš„å€¼æ¯”å³è¾¹å¤§
- `\uDCAB` ä¸€ä¸ª L

**è§£å†³åŠæ³•** - ä½¿ç”¨ ES6 æ–°å¢çš„**`u`**æ­£åˆ™ä¿®é¥°ç¬¦ï¼Œåé¢ä¼šæè¿°ã€‚

## æ•°é‡åŒ¹é…ä¸ astral symbol

æ­£åˆ™ä¸­å¯ä»¥ç”¨ä¸€äº›é‡è¯æ¥åŒ¹é…æŸä¸ªé€‰é¡¹å¤šæ¬¡,å¦‚`*`,`+`,Â `?`, andÂ `{n}`,Â `{n,}`,Â `{n,m}`ï¼Œè¿™äº›åœ¨å¤„ç† BMP å­—ç¬¦æ—¶æ²¡é—®é¢˜ï¼š

```js
/a{2}/.test('aa') //true
/\u0061{2}/.test('aa') // true
```

ä½†æ˜¯é‡åˆ°`astral symbol`ä¹Ÿä¼šå‡ºé—®é¢˜ï¼š

```js
/ğŸ’©{2}/.test('ğŸ’©ğŸ’©') // false
/\u{1F4A9}{2}/.test('ğŸ’©ğŸ’©') // false
```

åŸå› æ˜¯å› ä¸ºè¿™äº›æ­£åˆ™è¡¨è¾¾å¼å®é™…ä¸Šä¼šè¡¨è¾¾æˆ`<Hï¼ŒL>`çš„å½¢å¼ï¼š

```js
/\u{1F4A9}{2}/   => /\uD83D\uDCA9{2}/  // å…¶å®åŒ¹é…çš„æ˜¯ H+L*2
```

ä¸€ä¸ªå¯è¡Œçš„è§£å†³æ–¹æ¡ˆæ˜¯ç›´æ¥é‡‡ç”¨å¯¹åº”çš„`<Hï¼ŒL>`å½¢å¼æ¥å†™æ­£åˆ™ï¼š

```js
/(\uD83D\uDCA9){2}/.test('ğŸ’©ğŸ’©'); // true
```

æˆ–è€…ä½¿ç”¨**`u`**æ­£åˆ™ä¿®é¥°ç¬¦ã€‚

## u ä¿®é¥°ç¬¦

é˜®ä¸€å³°çš„[ES6 å…¥é—¨](http://es6.ruanyifeng.com/#docs/regex#u-%E4%BF%AE%E9%A5%B0%E7%AC%A6)ä¸­æ˜¯è¿™æ ·æè¿°çš„ï¼š

> ES6 å¯¹æ­£åˆ™è¡¨è¾¾å¼æ·»åŠ äº† u ä¿®é¥°ç¬¦ï¼Œå«ä¹‰ä¸ºâ€œUnicode æ¨¡å¼â€ï¼Œç”¨æ¥æ­£ç¡®å¤„ç†å¤§äº\uFFFF çš„ Unicode å­—ç¬¦ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¼šæ­£ç¡®å¤„ç†å››ä¸ªå­—èŠ‚çš„ UTF-16 ç¼–ç ã€‚

è¿™å°±è¡¨ç¤ºæˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨`u`ä¿®é¥°ç¬¦åŠ ä¸ŠåŸå§‹çš„ä»£ç ç‚¹å°±èƒ½åŒ¹é…æ‰€æœ‰çš„ Unicode å­—ç¬¦äº†ã€‚

**å•ä¸ªå­—ç¬¦åŒ¹é…**

```js
/\u0061/u.test('a') // true
/\u{1F4A9}/u.test('ğŸ’©') // true
/^.$/u.test('ğŸ’©') // true
```

**èŒƒå›´åŒ¹é…**

```js
/[\uD83D\uDCA9-\uD83D\uDCAB]/u.test('\uD83D\uDCA9')  // true .   match U+1F4A9
/[\u{1F4A9}-\u{1F4AB}]/u.test('\u{1F4A9}')  // true  match U+1F4A9
/[ğŸ’©-ğŸ’«]/u.test('ğŸ’©')      // true   match U+1F4A9

/[\uD83D\uDCA9-\uD83D\uDCAB]/u.test('\uD83D\uDCAA')  // true .   match U+1F4AA
/[\u{1F4A9}-\u{1F4AB}]/u.test('\u{1F4AA}')  // true  match U+1F4AA
/[ğŸ’©-ğŸ’«]/u.test("ğŸ’ª")      // true   match U+1F4AA

/[\uD83D\uDCA9-\uD83D\uDCAB]/u.test('\uD83D\uDCAB')  // true .   match U+1F4AB
/[\u{1F4A9}-\u{1F4AB}]/u.test('\u{1F4AB}')  // true  match U+1F4AB
/[ğŸ’©-ğŸ’«]/u.test('ğŸ’«')      // true   match U+1F4AB
```

**æ•°é‡åŒ¹é…**

```js
/ğŸ’©{2}/u.test('ğŸ’©ğŸ’©'); // true
```

**å…¶ä»–**

åå‘åŒ¹é…æ ‡è¯†ï¼ˆå¦‚`/[^a]/`ä»¥åŠ`/\S/`ã€`/\D/`ï¼‰åœ¨é‡åˆ°`astral symbols`éƒ½ä¼šå‡ºç°é—®é¢˜ï¼Œ`u`ä¿®é¥°ç¬¦ä¹Ÿä¼šè§£å†³ï¼š

```js
/^[^a]$/.test('ğŸ’©')  // false
/^\S$/.test('ğŸ’©')  // false


/^[^a]$/u.test('ğŸ’©')  // true
/^\S$/u.test('ğŸ’©') // true
```

## å¯¹ inputã€textarea çš„ patten å±æ€§å½±å“

å¹¸è¿çš„æ˜¯`u`ä¿®é¥°ç¬¦é»˜è®¤æ˜¯é™„åŠ åœ¨äº†`pattern`å±æ€§ä¸Šçš„ï¼š

```
<style>
	:invalid {
	 	color: red;
	}
	:valid {
	 	color: green;
	}
</style>

<form action="" class="form">
    <input type="text" pattern='a.b' value="aXXb">  <!-- red -->
    <input type="text" pattern='a.b' value="a1b">  <!-- green -->
    <input type="text" pattern='a.b' value="ağŸ’©b">  <!-- green -->
  </form>
```

## å…¼å®¹æ€§

å‚è€ƒ[test-RegExp_y_and_u_flags](http://kangax.github.io/compat-table/es6/#test-RegExp_y_and_u_flags)

![](/images/Unicode/u-flag-compatiable.png)

## u flag çš„æ³¨æ„äº‹é¡¹

çœ‹äº†ä»¥ä¸Šçš„æè¿°ï¼Œå¾ˆå®¹æ˜“è®©äººè§‰å¾—`u flag`æ˜¯ä¸‡èƒ½çš„ã€‚ ä¸è¿‡åœ¨å¤„ç†é—ç•™ä»£ç æ—¶è¿˜æ˜¯è¦æ³¨æ„ä¸€ä¸‹çš„ï¼Œå› ä¸º`u flag`ä¼šå‡å®šæ­£åˆ™è¡¨è¾¾å¼é‡Œçš„`\u`åé¢æ¥çš„æ˜¯ä¸€ä¸ªåˆæ³•çš„`Code Point`ï¼Œå¦‚æœä¸æ˜¯çš„è¯å°±ä¼šæŠ¥é”™ï¼š

```js
/\a/.test('a') // true

/\a/u.test('a') // Uncaught SyntaxError: Invalid regular expression: /\a/: Invalid escape
```

ä¸Šé¢çš„`\a`æ„å›¾æŠŠ`a`è½¬ä¹‰ï¼Œå®é™…ä¸Šå½“ç„¶æ˜¯ä¸èµ·ä½œç”¨çš„ï¼Œç­‰æ•ˆäº`/a/`ï¼Œä¸è¿‡å´ä¸ä¼šæŠ¥é”™çš„ã€‚ ä½†æ˜¯åŠ ä¸Š`u flag`åï¼Œä¼šç›´æ¥åˆ¤å®šéæ³•ã€‚

# UTF8 ç¼–ç 

Unicode åªæ˜¯ä¸€ä¸ªå­—ç¬¦é›†ï¼Œæ¯ä¸ªä»£ç ç‚¹çœŸæ­£åœ¨å­˜å‚¨å‰æ˜¯éœ€è¦è¿›è¡Œç¼–ç çš„ã€‚ åœ¨ utf-8 ç¼–ç ä¸­ï¼Œæœ€æ ¸å¿ƒçš„å°±æ˜¯ä¸€ä¸ªå¯¹åº”è¡¨ï¼š

![](/images/Unicode/utf-8ç¼–ç .png)

å¯ä»¥çœ‹åˆ°**ä¸åŒèŒƒå›´çš„ä»£ç ç‚¹åœ¨ç¼–ç åå¯èƒ½ä½¿ç”¨ 1~4 ä¸ªå­—èŠ‚è¡¨ç¤º**ã€‚

> UTF-8 çš„ç¼–ç è§„åˆ™å¾ˆç®€å•ï¼Œåªæœ‰äºŒæ¡ï¼š

> 1ï¼‰å¯¹äºå•å­—èŠ‚çš„ç¬¦å·ï¼Œå­—èŠ‚çš„ç¬¬ä¸€ä½è®¾ä¸º 0ï¼Œåé¢ 7 ä½ä¸ºè¿™ä¸ªç¬¦å·çš„ Unicode ç ã€‚å› æ­¤å¯¹äºè‹±è¯­å­—æ¯ï¼ŒUTF-8 ç¼–ç å’Œ ASCII ç æ˜¯ç›¸åŒçš„ã€‚

> 2ï¼‰å¯¹äº n å­—èŠ‚çš„ç¬¦å·ï¼ˆn > 1ï¼‰ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚çš„å‰ n ä½éƒ½è®¾ä¸º 1ï¼Œç¬¬ n + 1 ä½è®¾ä¸º 0ï¼Œåé¢å­—èŠ‚çš„å‰ä¸¤ä½ä¸€å¾‹è®¾ä¸º 10ã€‚å‰©ä¸‹çš„æ²¡æœ‰æåŠçš„äºŒè¿›åˆ¶ä½ï¼Œå…¨éƒ¨ä¸ºè¿™ä¸ªç¬¦å·çš„ Unicode ç ã€‚

ä¸¾ä¸ªä¾‹å­ï¼š
"ä¸¥"çš„ä»£ç ç‚¹æ˜¯`U+4E25`ï¼Œæ ¹æ®ä¸Šå›¾å‘ç°åœ¨ utf-8 ç¼–ç åæœ‰ 3 ä¸ªå­—èŠ‚ã€‚å…·ä½“ç¼–ç æ­¥éª¤è§ä¸‹å›¾ï¼ˆçº¯æ‰‹ç»˜ ğŸ˜„ï¼‰ï¼š
![](/images/Unicode/utf-8ç¼–ç ç¤ºä¾‹.jpeg)

å³"ä¸¥"åœ¨ utf-8 ç¼–ç åæ˜¯ç”¨`0xEBB8A5`æ¥è¡¨ç¤ºçš„ã€‚

**ä¸€ä¸ªç»†èŠ‚**ï¼šæ˜ å°„è¡¨é‡Œåé¢å­—èŠ‚çš„`10`æ˜¯ä¸ºäº†å¤„äºä»»ä½•ä¸€ä¸ªå­—èŠ‚æ—¶ï¼Œéƒ½çŸ¥é“å½“å‰æ˜¯ä¸€ä¸ªå•å­—èŠ‚ç¬¦å·è¿˜æ˜¯å¤šå­—èŠ‚ç¬¦å·ï¼Œå¦‚æœæ˜¯å¤šå­—èŠ‚ç¬¦å·ï¼Œé‚£ä¹ˆä»€ä¹ˆæ¥ä¸‹æ¥çš„å¤šå°‘ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªå®Œæ•´çš„ç¬¦å·ç»“æŸï¼š

- å¦‚æœå½“å‰å­—èŠ‚çš„ç¬¬ä¸€ä¸ºæ˜¯`0`ï¼Œé‚£ä¹ˆè¿™ä¸ªå­—èŠ‚å¿…ç„¶å°±æ˜¯ä¸€ä¸ªå•å­—èŠ‚ç¬¦å·ï¼›
- å¦‚æœå½“å‰å­—èŠ‚çš„å‰ä¸¤ä½æ˜¯`11`ï¼Œé‚£ä¹ˆå½“å‰å­—èŠ‚å¿…ç„¶æ˜¯ä¸€ä¸ªå¤šå­—èŠ‚ç¬¦å·çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼›
- å¦‚æœå‰ä¸¤ä½æ˜¯`10`ï¼Œé‚£ä¹ˆå½“å‰å­—èŠ‚å¿…ç„¶æ˜¯ä¸€ä¸ªå¤šå­—èŠ‚ç¬¦å·çš„æŸä¸ªä¸­é—´å­—èŠ‚ï¼Œå¹¶ä¸”ç›´åˆ°æ¥ä¸‹æ¥çš„æŸä¸ªå­—èŠ‚å‰ä¸¤ä½ä¸æ˜¯`10`äº†ï¼Œè¿™ä¸ªå¤šå­—èŠ‚ç¬¦å·æ‰ç»“æŸã€‚

## Unicode å­—ç¬¦è½¬ä¸º utf8 ç¼–ç åçš„å­—èŠ‚é•¿åº¦è®¡ç®—

1.  åˆ©ç”¨[encodeURIComponent](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/encodeURIComponent)è½¬ä¸º utf8 ç¼–ç ï¼š


    ```js
    encodeURIComponent('ğŸ’©')  // "%F0%9F%92%A9"
    ```

    	```js
    	function utf8Length(charactor){
    	  // Matches only the 10.. bytes that are non-initial characters in a multi-byte sequence.
        const m = encodeURIComponent(charactor).match(/%[89ABab]/g);
        return (m ? m.length : 0) + 1;
    	}

    	utf8Length("ğŸ’©") // 4
    	utf8Length("ä¸¥") // 3
    	utf8Length("a")  // 1
    	```

2.  ç›´æ¥é€šè¿‡ä»£ç ç‚¹ Code Point çš„èŒƒå›´è®¡ç®—


    ```js
    function utf8Length(charactor) {
        codePoint = charactor.codePointAt(0);
        // NOT charCodeAtï¼Œå› ä¸ºå…¶åªèƒ½è¿”å›0~FFFFçš„æ•´æ•°ï¼Œè§MDN
        // charCodeAt: https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/String/charCodeAt
        // codePointAt: https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/String/codePointAt
        if (codePoint <= 0x007f) {
            return 1;
        } else if (codePoint <= 0x07ff) {
            return 2;
        } else if (codePoint <= 0xffff) {
            return 3;
        }
        return 4;
    }

    utf8Length("ğŸ’©") // 4
    utf8Length("ä¸¥") // 3
    utf8Length("a")  // 1
    ```

## Unicode å­—ç¬¦ä¸²è½¬ utf8 ç¼–ç åçš„å­—èŠ‚é•¿åº¦è®¡ç®—

è¦æ³¨æ„çš„æ˜¯ String çš„ length å±æ€§è¡¨ç¤ºçš„æ˜¯ utf-16 ç¼–ç åçš„å­—èŠ‚é•¿åº¦,åŒç†`string[i]`è¡¨ç¤º i è¿™ä¸ªä½ç½®ä¸Šçš„ä¸€ä¸ª 2 å­—èŠ‚çš„ UTF-16 ç¼–ç å­—ç¬¦ã€‚ å¦‚æœ i ä½ç½®ä¸Šæ˜¯ä¸€ä¸ª 2 å­—èŠ‚ UTF-16 ç¼–ç å­—ç¬¦æ— æ³•è¡¨ç¤ºçš„`astral symbols`ï¼Œé‚£ä¹ˆå°±ä¼šæ˜¾ç¤ºä¹±ç ,å› ä¸ºæ­¤æ—¶`string[i]`æŒ‡å‘çš„æ˜¯ H æˆ– Lï¼Œå¿…é¡»`i`å’Œ`i+1`ä¸¤ä¸ªä½ç½®è”åˆèµ·æ¥æ‰èƒ½å®Œæ•´è¡¨ç¤ºã€‚

```js
'ğŸ’©'.length; // 2ï¼Œ æ³¨æ„ä¸Šé¢æˆ‘ä»¬è®¡ç®—çš„å®ƒåœ¨utf8ç¼–ç ä¸‹ä½¿ç”¨äº†4ä¸ªå­—èŠ‚
'ğŸ’©'[0]; // ""
'ğŸ’©'[1]; // ""
'ğŸ’©'.slice(0, 2); // "ğŸ’©"

'ä¸¥'.length; //1
'ä¸¥'[0]; // "ä¸¥"
```

çŸ¥é“è¿™ä¸€ç‚¹åï¼Œæˆ‘ä»¬æœ‰ 2 ç§æ–¹æ³•æ¥è®¡ç®—ä»»ä¸€å­—ç¬¦ä¸²è½¬ä¸º utf8 ç¼–ç åçš„å­—èŠ‚é•¿åº¦ï¼š

1.  å°å¿ƒç¿¼ç¿¼çš„å¤„ç†`astral symbols`çš„`Hã€L`éƒ¨åˆ† ,ä¸€æ­¥ä¸€ä¸ªè„šå°:

    ```js
    function strUtf8Length(str) {
      let index = 0;
      let total = 0;
      while (index < str.length) {
        const charCode = str.charCodeAt(index);

        console.log(`charCode:`, charCode.toString(16));

        if (0xd800 <= charCode && charCode <= 0xdbff) {
          // å¤„äºastral symbolsçš„HåŒºåŸŸ,è¯´æ˜å½“å‰str[index]ä¸str[index+1]æ‰èƒ½æ„æˆä¸€ä¸ªå®Œæ•´çš„Unicodeå­—ç¬¦
          total += utf8Length(str.slice(index, index + 2));
          index += 2;
        } else {
          // å¤„äºBMPåŒº(U+0000~U+FFFF)ï¼Œè¯´æ˜UTF-16ç¼–ç çš„å•ç‹¬str[index]å°±èƒ½è¡¨ç¤ºä¸€ä¸ªå®Œæ•´çš„Unicodeå­—ç¬¦
          total += utf8Length(str[index]);
          index += 1;
        }
      }
      return total;
    }

    console.log(strUtf8Length('ğŸ’©')); // 4
    console.log(strUtf8Length('ä¸¥')); // 3
    console.log(strUtf8Length('a')); // 1
    console.log(strUtf8Length('ğŸ’©ä¸¥a')); //8
    ```

2.  ES6 ä¸­çš„`for...of`ä¼šæ›¿æˆ‘ä»¬å¤„ç†ä¸Šé¢çš„é‚£äº›é‡å¤ç»†èŠ‚

    ```js
    function strUtf8Length2(str) {
      let total = 0;
      for (const symbol of str) {
        total += utf8Length(symbol); // symbolè¡¨ç¤ºæ¯ä¸€ä¸ªå•ç‹¬çš„Unicodeå­—ç¬¦
      }
      return total;
    }

    console.log(strUtf8Length2('ğŸ’©')); // 4
    console.log(strUtf8Length2('ä¸¥')); // 3
    console.log(strUtf8Length2('a')); // 1
    console.log(strUtf8Length2('ğŸ’©ä¸¥a')); //8
    ```

# å‚è€ƒ

1.  [javascript-unicode](https://mathiasbynens.be/notes/javascript-unicode)
2.  [è°ˆè°ˆ Unicode ç¼–ç ](http://pcedu.pconline.com.cn/empolder/gj/other/0505/616631_all.html#content_page_1)
3.  [Unicode ä¸ JavaScript è¯¦è§£](http://www.ruanyifeng.com/blog/2014/12/unicode.html)
4.  [wiki unicode](https://en.wikipedia.org/wiki/Unicode)
5.  [The Absolute Minimum Every Software Developer Absolutely, Positively Must Know About Unicode and Character Sets](https://www.joelonsoftware.com/2003/10/08/the-absolute-minimum-every-software-developer-absolutely-positively-must-know-about-unicode-and-character-sets-no-excuses/)
6.  [Unicode-aware regular expressions in ES2015](https://mathiasbynens.be/notes/es6-unicode-regex)
7.  [es6 å­—ç¬¦ä¸²çš„æ‰©å±•](http://es6.ruanyifeng.com/#docs/string)
8.  [es6 æ­£åˆ™çš„æ‰©å±•](http://es6.ruanyifeng.com/#docs/regex)
9.  [ASCIIï¼ŒUnicode å’Œ UTF-8](http://www.ruanyifeng.com/blog/2007/10/ascii_unicode_and_utf-8.html)
