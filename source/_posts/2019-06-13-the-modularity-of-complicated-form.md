---
title: 复杂表单的模块化处理
date: 2019-06-13 15:54:37
summary_img: /images/bora-bora.jpg
tags: [js, architecture]
---

工作中或多或少都会遇到表单，而我遇到的表单逻辑都非常复杂😭。 通常的特点是每个表单项自身都有一大坨逻辑，好几百行代码，如果将所有表单项都放到一个文件里，那么没人能看得懂它，维护起来是一个噩梦。为了解决这个问题，之前做过一些封装和拆分：

* 将每个表单项封装成独立组件
* 在业务上将表单项分类，功能内聚的一组表单项放到一个`form group`下，这样整个表单被拆分为多个`form group`，同时每个`form group`也封装成组件：

![form-group-split](form-group-split.png)

* `form`汇集下属所有`form group`的互操作和业务逻辑，同时`form group`汇集下属所有`form item`的互操作和业务逻辑。例如收集表单提交时的接口数据，表单项显隐的控制
* 统一数据流管理，放到`vuex`中，但不够彻底，组件内部仍然有维护小部分数据

上面这样做在表单复杂度不是那么高时可以很好应对，但随着业务越来越复杂，遇到了新的问题：

* `form`和`form group`由于需要汇集下属所有组件的互操作和业务逻辑，导致组件变的非常大，代码可以很轻易的增长到上千行
* 每个表单项的逻辑散落在多处，难以整理出其具体是怎么工作的
* 维护困难，虽然可能单独一个表单项的逻辑只有几百行，但是混杂在了父组件上千行的代码中，轻易不敢乱动

仔细思考了困境，发现其实`form`和`form group`并不需要维护具体的业务逻辑，它们应当只是做一些简单的汇总工作。如果将业务逻辑全部内聚到单独的表单项，那么维护起来将会非常方便。表单项的核心逻辑有：

* 为了能够工作，需要从完整的`form data`中获取哪些数据
* 当表单提交时，自身需要贡献哪些数据到`form data`
* 是否展示、隐藏的控制逻辑，一个表单项的显隐通常是受到某些其他表单项、上层`form`、`form group`组件的状态影响
* 所有数据完全由`vuex`托管，不再散落多处
* 每个表单项独立的`module`，`form group`也有独立`module`，与组件树一一对应形成`module tree`

表单项完全自治内聚，`form`只用在初始化时将后端拉取的完整`form data`传递给表单项，由表单项自行关心的字段；在表单提交时，由于表单项内部已经准备好需要贡献哪些数据，`form`只用直接拿过来即可。

基于以上思路，势必有很多通用逻辑，提取出来后就可以方便的复用了。`demo`代码放在最后，下面具体说说实现细节。

# 总体架构