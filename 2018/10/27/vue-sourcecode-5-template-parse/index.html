<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">



  <meta name="google-site-verification" content="MpEos65SsDadcqkPQvdQGXTTDcUJqQhcC2OpPRp4quU">














  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Vue,javascript,">










<meta name="description" content="Vue 源码可以分为 3 大块：双向绑定、patch 算法和模板解析。其中又以模板解析最为复杂，它是用来将我们写的template模板编译成render函数，可以猜到如果我们直接写render，那么整个解析过程就可以跳过，而且分析其中的代码可以看出这个解析的过程其实是很独立的。 前面的文章也有提到，模板解析主要分为 3 个步骤：  parse，用于将template解析为AST optimize,">
<meta name="keywords" content="Vue,javascript">
<meta property="og:type" content="article">
<meta property="og:title" content="Vue源码解析5-模板解析parse">
<meta property="og:url" content="https://hellogithub2014.github.io/2018/10/27/vue-sourcecode-5-template-parse/index.html">
<meta property="og:site_name" content="十年一刻">
<meta property="og:description" content="Vue 源码可以分为 3 大块：双向绑定、patch 算法和模板解析。其中又以模板解析最为复杂，它是用来将我们写的template模板编译成render函数，可以猜到如果我们直接写render，那么整个解析过程就可以跳过，而且分析其中的代码可以看出这个解析的过程其实是很独立的。 前面的文章也有提到，模板解析主要分为 3 个步骤：  parse，用于将template解析为AST optimize,">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://hellogithub2014.github.io/images/vue-source-code/parse/ast-1.png">
<meta property="og:image" content="https://hellogithub2014.github.io/images/vue-source-code/parse/ast-2.png">
<meta property="og:updated_time" content="2019-05-25T10:11:19.536Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Vue源码解析5-模板解析parse">
<meta name="twitter:description" content="Vue 源码可以分为 3 大块：双向绑定、patch 算法和模板解析。其中又以模板解析最为复杂，它是用来将我们写的template模板编译成render函数，可以猜到如果我们直接写render，那么整个解析过程就可以跳过，而且分析其中的代码可以看出这个解析的过程其实是很独立的。 前面的文章也有提到，模板解析主要分为 3 个步骤：  parse，用于将template解析为AST optimize,">
<meta name="twitter:image" content="https://hellogithub2014.github.io/images/vue-source-code/parse/ast-1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'Z5V8KL0XIZ',
      apiKey: '88610a56e4ab954825661f14975c6a43',
      indexName: 'hexo-blog',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://hellogithub2014.github.io/2018/10/27/vue-sourcecode-5-template-parse/">





  <title>Vue源码解析5-模板解析parse | 十年一刻</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?41d97f95198aa53fcbe7f25b20a44ee3";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>





  
</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">十年一刻</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hellogithub2014.github.io/2018/10/27/vue-sourcecode-5-template-parse/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liu Bin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1544633647623&di=9344c3068a2e155434bd39899d7cd25d&imgtype=0&src=http%3A%2F%2Fpic65.nipic.com%2Ffile%2F20150428%2F12641788_080744824000_2.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="十年一刻">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Vue源码解析5-模板解析parse</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-27T15:20:00+08:00">
                2018-10-27
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/10/27/vue-sourcecode-5-template-parse/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/10/27/vue-sourcecode-5-template-parse/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv">本文总阅读量
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>次
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Vue 源码可以分为 3 大块：<strong>双向绑定</strong>、<strong>patch 算法</strong>和<strong>模板解析</strong>。其中又以模板解析最为复杂，它是用来将我们写的<code>template</code>模板编译成<code>render</code>函数，可以猜到如果我们直接写<code>render</code>，那么整个解析过程就可以跳过，而且分析其中的代码可以看出这个解析的过程其实是很独立的。</p>
<p>前面的文章也有提到，模板解析主要分为 3 个步骤：</p>
<ol>
<li><code>parse</code>，用于将<code>template</code>解析为<code>AST</code></li>
<li><code>optimize</code>,用于优化静态内容的渲染，主要是给静态节点打上一些标记</li>
<li><code>generate</code>，用于根据<code>AST</code>生成<code>render</code>函数</li>
</ol>
<p>相关的核心代码位于<code>src/compiler/index.js</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ast = parse(template.trim(), options);</span><br><span class="line"><span class="keyword">if</span> (options.optimize !== <span class="literal">false</span>) &#123;</span><br><span class="line">  optimize(ast, options);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> code = generate(ast, options);</span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  ast,</span><br><span class="line">  render: code.render,</span><br><span class="line">  staticRenderFns: code.staticRenderFns,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这篇文章主要说第一步：将<code>template</code>解析为<code>AST</code>，主要思路还是逐步解析<code>template</code>字符串，涉及的代码会比较多。</p>
<h1 id="入口"><a href="#入口" class="headerlink" title="入口"></a>入口</h1><p><code>parse</code>函数定义位于<code>src/compiler/parser/index.js</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Convert HTML string to AST.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parse</span> (<span class="params">template: string, options: CompilerOptions</span>): <span class="title">ASTElement</span> | <span class="title">void</span> </span>&#123;</span><br><span class="line">  warn = options.warn || baseWarn</span><br><span class="line"></span><br><span class="line">  <span class="comment">// isPreTag、mustUseProp、getTagNamespace定义位于src/platforms/web/compiler/options.js</span></span><br><span class="line">  platformIsPreTag = options.isPreTag || no</span><br><span class="line">  platformMustUseProp = options.mustUseProp || no</span><br><span class="line">  platformGetTagNamespace = options.getTagNamespace || no</span><br><span class="line"></span><br><span class="line">  <span class="comment">// options.modules见/platforms/web/compiler/modules/index.js,</span></span><br><span class="line">  <span class="comment">// 包含[klass,style,model]3个module成员</span></span><br><span class="line">  <span class="comment">// pluckModuleFunction：获取每个module中的transformNode成员</span></span><br><span class="line">  transforms = pluckModuleFunction(options.modules, <span class="string">'transformNode'</span>) <span class="comment">// klass、style中有定义</span></span><br><span class="line">  preTransforms = pluckModuleFunction(options.modules, <span class="string">'preTransformNode'</span>) <span class="comment">// model中有定义</span></span><br><span class="line">  postTransforms = pluckModuleFunction(options.modules, <span class="string">'postTransformNode'</span>) <span class="comment">// 没找到</span></span><br><span class="line"></span><br><span class="line">  delimiters = options.delimiters</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> stack = []</span><br><span class="line">  <span class="keyword">const</span> preserveWhitespace = options.preserveWhitespace !== <span class="literal">false</span></span><br><span class="line">  <span class="keyword">let</span> root</span><br><span class="line">  <span class="keyword">let</span> currentParent</span><br><span class="line">  <span class="keyword">let</span> inVPre = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">let</span> inPre = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">let</span> warned = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 用于在解析过程中“关闭”一个节点</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">closeElement</span> (<span class="params">element</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  parseHTML(template,</span><br><span class="line">  &#123;</span><br><span class="line">    warn,</span><br><span class="line">    expectHTML: options.expectHTML, <span class="comment">// 各种选项，基本都可以从命名来猜到意思</span></span><br><span class="line">    isUnaryTag: options.isUnaryTag, <span class="comment">// 是否是单标签</span></span><br><span class="line">    canBeLeftOpenTag: options.canBeLeftOpenTag,</span><br><span class="line">    shouldDecodeNewlines: options.shouldDecodeNewlines,</span><br><span class="line">    shouldDecodeNewlinesForHref: options.shouldDecodeNewlinesForHref,</span><br><span class="line">    shouldKeepComment: options.comments,</span><br><span class="line">    <span class="comment">// 在解析html过程中处理标签的起始节点</span></span><br><span class="line">    start (tag, attrs, unary) &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 在解析html过程中处理标签的结束节点</span></span><br><span class="line">    end () &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 在解析html过程中处理纯文本</span></span><br><span class="line">    chars (text: string) &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 在解析html过程中处理注释</span></span><br><span class="line">    comment()&#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以很容易看出来最核心的是其中的<code>parseHTML</code>函数，其余都是一些影响解析的配置选项。 另外<code>transforms</code>和<code>preTransforms</code>会在用到时再细说。</p>
<h1 id="parseHTML"><a href="#parseHTML" class="headerlink" title="parseHTML"></a>parseHTML</h1><p>这个函数的总体思路是逐步解析<code>html</code>字符串，将<code>html</code>文本分为了几类，分别处理：</p>
<ol>
<li>普通的注释节点</li>
<li>IE 的条件注释 (<code>&lt;![</code>开头)</li>
<li>Doctype</li>
<li>起始标签</li>
<li>结束标签</li>
<li>纯文本</li>
<li><code>script、style、textarea</code>节点</li>
</ol>
<p>通过正则表达式判断属于何种类型的节点，具体的表达式长什么样碰到了会说。</p>
<p>函数的大体轮廓：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">parseHTML</span>(<span class="params">html, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> stack = [];</span><br><span class="line">  <span class="keyword">const</span> expectHTML = options.expectHTML;</span><br><span class="line">  <span class="keyword">const</span> isUnaryTag = options.isUnaryTag || no;</span><br><span class="line">  <span class="keyword">const</span> canBeLeftOpenTag = options.canBeLeftOpenTag || no;</span><br><span class="line">  <span class="keyword">let</span> index = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> last, lastTag;</span><br><span class="line">  <span class="keyword">while</span> (html) &#123;</span><br><span class="line">    <span class="comment">// 逐步处理html字符串...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Clean up any remaining tags</span></span><br><span class="line">  parseEndTag();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// index递进到指定位置，并截取html</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">advance</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">    index += n;</span><br><span class="line">    html = html.substring(n);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 解析起始标签</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">parseStartTag</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 处理起始标签</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleStartTag</span>(<span class="params">match</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 。。。</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 处理结束标签</span></span><br><span class="line"><span class="comment">   * @param &#123;String&#125; tagName 标签名，如'a'</span></span><br><span class="line"><span class="comment">   * @param &#123;Number&#125; start 标签名在html字符串中的起始位置,如79</span></span><br><span class="line"><span class="comment">   * @param &#123;Number&#125; end 标签名在html字符串中的结束位置，如83</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">parseEndTag</span>(<span class="params">tagName, start, end</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="while-html"><a href="#while-html" class="headerlink" title="while (html)"></a>while (html)</h2><p>这个循环会针对上面提的每种类型做处理，虽然代码比较多，但除了起始标签和结束标签外的逻辑都很清晰易懂，我也添加了非常详细的注释。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (html) &#123;</span><br><span class="line">  last = html;</span><br><span class="line">  <span class="comment">// Make sure we're not in a plaintext content element like script/style</span></span><br><span class="line">  <span class="comment">// isPlainTextElement：判断是否script、style、textarea</span></span><br><span class="line">  <span class="comment">// lastTag：最近正在处理的起始标签，在parseStartTag和parseEndTag会被设置</span></span><br><span class="line">  <span class="keyword">if</span> (!lastTag || !isPlainTextElement(lastTag)) &#123;</span><br><span class="line">    <span class="keyword">let</span> textEnd = html.indexOf(<span class="string">'&lt;'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果当前剩余的html是以&lt;开头的，那么很有可能它是注释、条件注释、Doctype、结束标签、开始标签中的一个</span></span><br><span class="line">    <span class="comment">// if里面的逻辑就是挨个尝试每一种可能</span></span><br><span class="line">    <span class="keyword">if</span> (textEnd === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// Comment注释</span></span><br><span class="line">      <span class="keyword">if</span> (comment.test(html)) &#123;</span><br><span class="line">        <span class="keyword">const</span> commentEnd = html.indexOf(<span class="string">'--&gt;'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (commentEnd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (options.shouldKeepComment) &#123;</span><br><span class="line">            <span class="comment">// 调用parse方法传递的comment选项</span></span><br><span class="line">            options.comment(html.substring(<span class="number">4</span>, commentEnd));</span><br><span class="line">          &#125;</span><br><span class="line">          advance(commentEnd + <span class="number">3</span>); <span class="comment">// index递进到指定位置，html截取</span></span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// http://en.wikipedia.org/wiki/Conditional_comment#Downlevel-revealed_conditional_comment</span></span><br><span class="line">      <span class="comment">// IE的条件注释 &lt;![开头</span></span><br><span class="line">      <span class="keyword">if</span> (conditionalComment.test(html)) &#123;</span><br><span class="line">        <span class="keyword">const</span> conditionalEnd = html.indexOf(<span class="string">']&gt;'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (conditionalEnd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">          advance(conditionalEnd + <span class="number">2</span>);</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Doctype:</span></span><br><span class="line">      <span class="keyword">const</span> doctypeMatch = html.match(doctype);</span><br><span class="line">      <span class="keyword">if</span> (doctypeMatch) &#123;</span><br><span class="line">        advance(doctypeMatch[<span class="number">0</span>].length);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// End tag结束标签</span></span><br><span class="line">      <span class="comment">// 若html为'&lt;/a&gt;'，则endTagMatch为['&lt;/a&gt;','a',groups:undefined,index:0]</span></span><br><span class="line">      <span class="keyword">const</span> endTagMatch = html.match(endTag);</span><br><span class="line">      <span class="keyword">if</span> (endTagMatch) &#123;</span><br><span class="line">        <span class="keyword">const</span> curIndex = index;</span><br><span class="line">        advance(endTagMatch[<span class="number">0</span>].length);</span><br><span class="line">        parseEndTag(endTagMatch[<span class="number">1</span>], curIndex, index);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Start tag其实标签</span></span><br><span class="line">      <span class="keyword">const</span> startTagMatch = parseStartTag();</span><br><span class="line">      <span class="keyword">if</span> (startTagMatch) &#123;</span><br><span class="line">        handleStartTag(startTagMatch);</span><br><span class="line">        <span class="keyword">if</span> (shouldIgnoreFirstNewline(lastTag, html)) &#123;</span><br><span class="line">          advance(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> text, rest, next;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * 如果当前剩余的html不是以&lt;开头，那么有可能是纯文本。例如：</span></span><br><span class="line"><span class="comment">       * `</span></span><br><span class="line"><span class="comment">       * 这里是文本</span></span><br><span class="line"><span class="comment">            &lt;a :href="url" target="_blank"&gt;前面的文本&#123;&#123;title&#125;&#125;后面的文本&lt;/a&gt;</span></span><br><span class="line"><span class="comment">            &lt;img :src="img"&gt;</span></span><br><span class="line"><span class="comment">          &lt;/div&gt;</span></span><br><span class="line"><span class="comment">       * `</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    <span class="keyword">if</span> (textEnd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      rest = html.slice(textEnd);</span><br><span class="line">      <span class="comment">// 如果剩下的以&lt;开头的那段，不是结束标签、开始标签、注释、条件注释，那么它很有可能就是一个孤零零的&lt;字符</span></span><br><span class="line">      <span class="comment">// 继续往后递进，直到再也没有&lt;，或者其中一个while条件不满足</span></span><br><span class="line">      <span class="keyword">while</span> (!endTag.test(rest) &amp;&amp; !startTagOpen.test(rest) &amp;&amp; !comment.test(rest) &amp;&amp; !conditionalComment.test(rest)) &#123;</span><br><span class="line">        <span class="comment">// &lt; in plain text, be forgiving and treat it as text</span></span><br><span class="line">        next = rest.indexOf(<span class="string">'&lt;'</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (next &lt; <span class="number">0</span>) <span class="keyword">break</span>; <span class="comment">// 如果后面再也没有&lt;，直接跳出while</span></span><br><span class="line">        textEnd += next;</span><br><span class="line">        rest = html.slice(textEnd); <span class="comment">// 递进到下一段以&lt;开头的文本</span></span><br><span class="line">      &#125;</span><br><span class="line">      text = html.substring(<span class="number">0</span>, textEnd); <span class="comment">// 截取位于之间的纯文本，如’这里是文本‘</span></span><br><span class="line">      advance(textEnd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果剩下的文本没有&lt;了，那么它们就都是纯文本了</span></span><br><span class="line">    <span class="keyword">if</span> (textEnd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      text = html;</span><br><span class="line">      html = <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options.chars &amp;&amp; text) &#123;</span><br><span class="line">      options.chars(text); <span class="comment">// 调用位于parse中的chars配置</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 如果处理到了script、style、textarea。例如</span></span><br><span class="line"><span class="comment">     * 原始html=`&lt;div&gt;&lt;script&gt;console.log( 123 )&lt;/script&gt;&lt;/div&gt;`,</span></span><br><span class="line"><span class="comment">     * 在此时lastTag = `script`,html剩余`console.log( 123 )&lt;/script&gt;&lt;/div&gt;`</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">let</span> endTagLength = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> stackedTag = lastTag.toLowerCase();</span><br><span class="line">    <span class="comment">// 匹配到对应的script/style/textarea闭标签</span></span><br><span class="line">    <span class="keyword">const</span> reStackedTag = reCache[stackedTag] || (reCache[stackedTag] = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">'([\\s\\S]*?)(&lt;/'</span> + stackedTag + <span class="string">'[^&gt;]*&gt;)'</span>, <span class="string">'i'</span>));</span><br><span class="line">    <span class="keyword">const</span> rest = html.replace(reStackedTag, <span class="function"><span class="keyword">function</span>(<span class="params">all, text, endTag</span>) </span>&#123;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * all = "console.log( 123 )&lt;/script&gt;"</span></span><br><span class="line"><span class="comment">       * text='console.log( 123 )'</span></span><br><span class="line"><span class="comment">       * endTag="&lt;/script&gt;"</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      endTagLength = endTag.length;</span><br><span class="line">      <span class="keyword">if</span> (!isPlainTextElement(stackedTag) &amp;&amp; stackedTag !== <span class="string">'noscript'</span>) &#123;</span><br><span class="line">        text = text</span><br><span class="line">          .replace(<span class="regexp">/&lt;!\--([\s\S]*?)--&gt;/g</span>, <span class="string">'$1'</span>) <span class="comment">// #7298</span></span><br><span class="line">          .replace(<span class="regexp">/&lt;!\[CDATA\[([\s\S]*?)]]&gt;/g</span>, <span class="string">'$1'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (shouldIgnoreFirstNewline(stackedTag, text)) &#123;</span><br><span class="line">        text = text.slice(<span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (options.chars) &#123;</span><br><span class="line">        options.chars(text);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 此时rest为去除script/style/textarea后剩下的</span></span><br><span class="line">    index += html.length - rest.length;</span><br><span class="line">    html = rest;</span><br><span class="line">    parseEndTag(stackedTag, index - endTagLength, index); <span class="comment">// 处理script/style/textarea结束标签</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 一些尾校验略去...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到对于注释、Doctype、条件注释，Vue 通常会直接跳过，在处理纯文本和标签时花费了比较多的代码。我们先把一些零碎的细节理一理，主要是几种正则，以及如何处理<code>comment</code>和纯文本<code>chars</code>的。</p>
<h3 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h3><p><strong>comment 注释</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> comment = <span class="regexp">/^&lt;!\--/</span>; <span class="comment">// 匹配 &lt;!--</span></span><br></pre></td></tr></table></figure>
<p><strong>conditionalComment 条件注释</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> conditionalComment = <span class="regexp">/^&lt;!\[/</span>; <span class="comment">// 匹配&lt;![</span></span><br></pre></td></tr></table></figure>
<p><strong>doctype</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> doctype = <span class="regexp">/^&lt;!DOCTYPE [^&gt;]+&gt;/i</span>; <span class="comment">// 匹配&lt;!DOCTYPE xxx&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>endTag 结束标签</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ncname = <span class="string">'[a-zA-Z_][\\w\\-\\.]*'</span>; <span class="comment">// 以a-zA-Z_开头，后面连接多个a-zA-Z-.</span></span><br><span class="line"><span class="keyword">const</span> qnameCapture = <span class="string">`((?:<span class="subst">$&#123;ncname&#125;</span>\\:)?<span class="subst">$&#123;ncname&#125;</span>)`</span>; <span class="comment">// ncname:ncname, 用于匹配命名空间如 svg:path</span></span><br><span class="line"><span class="keyword">const</span> endTag = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">`^&lt;\\/<span class="subst">$&#123;qnameCapture&#125;</span>[^&gt;]*&gt;`</span>); <span class="comment">// 结束标签</span></span><br></pre></td></tr></table></figure>
<p><strong>startTagOpen 起始标签</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> startTagOpen = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">`^&lt;<span class="subst">$&#123;qnameCapture&#125;</span>`</span>); <span class="comment">// 起始标签</span></span><br><span class="line"><span class="keyword">const</span> startTagClose = <span class="regexp">/^\s*(\/?)&gt;/</span>; <span class="comment">// 起始标签的结束部分</span></span><br></pre></td></tr></table></figure>
<p>测试：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'&lt;svg:path /&gt;'</span>.match(startTagOpen); <span class="comment">// ["&lt;svg:path", "svg:path", index: 0, input: "&lt;svg:path /&gt;"]</span></span><br><span class="line"><span class="string">'&lt;svg:path.test /&gt;'</span>.match(startTagOpen); <span class="comment">// ["&lt;svg:path.test", "svg:path.test", index: 0, input: "&lt;svg:path.test /&gt;"]</span></span><br><span class="line"></span><br><span class="line"><span class="string">' /&gt;'</span>.match(startTagClose); <span class="comment">// [" /&gt;", "/", index: 0, input: " /&gt;"]</span></span><br><span class="line"><span class="string">' &gt;'</span>.match(startTagClose); <span class="comment">// [" &gt;", "", index: 0, input: " &gt;"]</span></span><br></pre></td></tr></table></figure>
<p><strong>attribute 标签属性</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> attribute = <span class="regexp">/^\s*([^\s"'&lt;&gt;\/=]+)(?:\s*(=)\s*(?:"([^"]*)"+|'([^']*)'+|([^\s"'=&lt;&gt;`]+)))?/</span>; <span class="comment">// 匹配标签属性，如href="www.baidu.com" 或 href='www.baidu.com'</span></span><br></pre></td></tr></table></figure>
<p>测试：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"href='https://www.baidu.com'"</span>.match(attribute); <span class="comment">// ["href='https://www.baidu.com'", "href", "=", undefined, "https://www.baidu.com", undefined, index: 0, input: "href='https://www.baidu.com'"]</span></span><br></pre></td></tr></table></figure>
<h3 id="options-comment"><a href="#options-comment" class="headerlink" title="options.comment"></a>options.comment</h3><p>这个是用于处理遇到的 html comment：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">comment (text: string) &#123;</span><br><span class="line">     currentParent.children.push(&#123;</span><br><span class="line">       type: <span class="number">3</span>,</span><br><span class="line">       text,</span><br><span class="line">       isComment: <span class="literal">true</span></span><br><span class="line">     &#125;)</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p><code>currentParent</code>是当前正在处理标签元素的父元素，后面还说详细说到。</p>
<h3 id="options-chars"><a href="#options-chars" class="headerlink" title="options.chars"></a>options.chars</h3><p>处理遇到的纯文本。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">chars (text: string) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!currentParent) &#123;</span><br><span class="line">        <span class="comment">// 一些警告略去。。。</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ...IE bug fix 略去</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> children = currentParent.children</span><br><span class="line">      text =</span><br><span class="line">        inPre || text.trim()</span><br><span class="line">          ? isTextTag(currentParent) <span class="comment">// script或style</span></span><br><span class="line">            ? text</span><br><span class="line">            : decodeHTMLCached(text)</span><br><span class="line">          : <span class="comment">// only preserve whitespace if its not right after a starting tag</span></span><br><span class="line">          preserveWhitespace &amp;&amp; children.length</span><br><span class="line">            ? <span class="string">' '</span></span><br><span class="line">            : <span class="string">''</span></span><br><span class="line">      <span class="keyword">if</span> (text) &#123;</span><br><span class="line">        <span class="keyword">let</span> res</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 处理文本中的插值表达式，如text=`前面的文本&#123;&#123;title&#125;&#125;后面的文本`,则res为</span></span><br><span class="line"><span class="comment">         * &#123;</span></span><br><span class="line"><span class="comment">         *    expression: ""前面的文本"+_s(title)+"后面的文本""，</span></span><br><span class="line"><span class="comment">         *    tokens：&#123;</span></span><br><span class="line"><span class="comment">         *      0: "前面的文本"，</span></span><br><span class="line"><span class="comment">         *      1：&#123;</span></span><br><span class="line"><span class="comment">         *        @binding: "title"</span></span><br><span class="line"><span class="comment">         *      &#125;</span></span><br><span class="line"><span class="comment">         *      2: "后面的文本"</span></span><br><span class="line"><span class="comment">         *    &#125;</span></span><br><span class="line"><span class="comment">         * &#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (!inVPre &amp;&amp; text !== <span class="string">' '</span> &amp;&amp; (res = parseText(text, delimiters))) &#123;</span><br><span class="line">          children.push(&#123;</span><br><span class="line">            type: <span class="number">2</span>,</span><br><span class="line">            expression: res.expression,</span><br><span class="line">            tokens: res.tokens,</span><br><span class="line">            text</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (text !== <span class="string">' '</span> || !children.length || children[children.length - <span class="number">1</span>].text !== <span class="string">' '</span>) &#123;</span><br><span class="line">          children.push(&#123;</span><br><span class="line">            type: <span class="number">3</span>,</span><br><span class="line">            text</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>
<p><code>inVPre</code>我们很少用到，可以当做<code>false</code>处理。这里遇到一个<code>parseText</code>函数，如注释所说是用于处理文本中的插值表达式的。</p>
<h3 id="parseText"><a href="#parseText" class="headerlink" title="parseText"></a>parseText</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理文本中的插值表达式，如text=`前面的文本&#123;&#123;title&#125;&#125;后面的文本`,则res为</span></span><br><span class="line"><span class="comment"> * &#123;</span></span><br><span class="line"><span class="comment"> *    expression: `"前面的文本"+_s(title)+"后面的文本"`，</span></span><br><span class="line"><span class="comment"> *    tokens：[</span></span><br><span class="line"><span class="comment"> *      "前面的文本"，</span></span><br><span class="line"><span class="comment"> *      &#123;</span></span><br><span class="line"><span class="comment"> *        @binding: "title"</span></span><br><span class="line"><span class="comment"> *      &#125;,</span></span><br><span class="line"><span class="comment"> *      "后面的文本"</span></span><br><span class="line"><span class="comment"> *    ]</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">parseText</span>(<span class="params">text: string, delimiters?: [string, string]</span>): <span class="title">TextParseResult</span> | <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> tagRE = delimiters ? buildRegex(delimiters) : defaultTagRE;</span><br><span class="line">  <span class="keyword">if</span> (!tagRE.test(text)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> tokens = []; <span class="comment">// 主要用于存放text被&#123;&#123;&#125;&#125;切割的分段子文本</span></span><br><span class="line">  <span class="keyword">const</span> rawTokens = []; <span class="comment">// rawTokens和tokens的差别主要在处理插值表达式</span></span><br><span class="line">  <span class="keyword">let</span> lastIndex = (tagRE.lastIndex = <span class="number">0</span>); <span class="comment">// lastIndex: 每次正则表达式匹配结束后，下一次匹配的起始位置</span></span><br><span class="line">  <span class="keyword">let</span> match, index, tokenValue;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * text=`前面的文本&#123;&#123;title&#125;&#125;后面的文本`,则match为</span></span><br><span class="line"><span class="comment">   * [</span></span><br><span class="line"><span class="comment">   *    0: "&#123;&#123;title&#125;&#125;",</span></span><br><span class="line"><span class="comment">        1: "title",</span></span><br><span class="line"><span class="comment">        groups: undefined,</span></span><br><span class="line"><span class="comment">        index: 5,</span></span><br><span class="line"><span class="comment">   * ]</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">while</span> ((match = tagRE.exec(text))) &#123;</span><br><span class="line">    index = match.index;</span><br><span class="line">    <span class="comment">// push text token</span></span><br><span class="line">    <span class="keyword">if</span> (index &gt; lastIndex) &#123;</span><br><span class="line">      rawTokens.push((tokenValue = text.slice(lastIndex, index)));</span><br><span class="line">      tokens.push(<span class="built_in">JSON</span>.stringify(tokenValue));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// tag token</span></span><br><span class="line">    <span class="keyword">const</span> exp = parseFilters(match[<span class="number">1</span>].trim());</span><br><span class="line">    tokens.push(<span class="string">`_s(<span class="subst">$&#123;exp&#125;</span>)`</span>);</span><br><span class="line">    rawTokens.push(&#123; <span class="string">'@binding'</span>: exp &#125;);</span><br><span class="line">    lastIndex = index + match[<span class="number">0</span>].length;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (lastIndex &lt; text.length) &#123;</span><br><span class="line">    rawTokens.push((tokenValue = text.slice(lastIndex)));</span><br><span class="line">    tokens.push(<span class="built_in">JSON</span>.stringify(tokenValue));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    expression: tokens.join(<span class="string">'+'</span>),</span><br><span class="line">    tokens: rawTokens,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>tagRE</code>表示如何匹配插值表达式，默认配置<code>/\{\{((?:.|\n)+?)\}\}/g</code>，表示匹配<code>\{\{ xxx \}\}</code>。另外要注意的是插值表达式可以和过滤器一起使用，所以这里也做了处理。</p>
<h3 id="parseFilters"><a href="#parseFilters" class="headerlink" title="parseFilters"></a>parseFilters</h3><p><code>parseFilters</code>将入参看成是 <code>expression+filters</code>的结构，最终返回一个拼接的字符串。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> validDivisionCharRE = <span class="regexp">/[\w).+\-_$\]]/</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// parseFilters将入参看成是 expression+filters结构，</span></span><br><span class="line"><span class="comment">// 最终返回拼接的字符串，如"_f("upper")(title)"</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">parseFilters</span>(<span class="params">exp: string</span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> inSingle = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">let</span> inDouble = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">let</span> inTemplateString = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">let</span> inRegex = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">let</span> curly = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> square = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> paren = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> lastFilterIndex = <span class="number">0</span>; <span class="comment">// 最近一次发现过滤器|的位置</span></span><br><span class="line">  <span class="keyword">let</span> c, prev, i, expression, filters;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; exp.length; i++) &#123;</span><br><span class="line">    prev = c; <span class="comment">// 前一个字符</span></span><br><span class="line">    c = exp.charCodeAt(i); <span class="comment">// 当前字符</span></span><br><span class="line">    <span class="keyword">if</span> (inSingle) &#123;</span><br><span class="line">      <span class="comment">// 0x27 =&gt; '  0x5c =&gt; \</span></span><br><span class="line">      <span class="keyword">if</span> (c === <span class="number">0x27</span> &amp;&amp; prev !== <span class="number">0x5c</span>) inSingle = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (inDouble) &#123;</span><br><span class="line">      <span class="comment">// 0x22 =&gt; "</span></span><br><span class="line">      <span class="keyword">if</span> (c === <span class="number">0x22</span> &amp;&amp; prev !== <span class="number">0x5c</span>) inDouble = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (inTemplateString) &#123;</span><br><span class="line">      <span class="comment">// 0x60 =&gt; `</span></span><br><span class="line">      <span class="keyword">if</span> (c === <span class="number">0x60</span> &amp;&amp; prev !== <span class="number">0x5c</span>) inTemplateString = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (inRegex) &#123;</span><br><span class="line">      <span class="comment">// 0x2f =&gt; /</span></span><br><span class="line">      <span class="keyword">if</span> (c === <span class="number">0x2f</span> &amp;&amp; prev !== <span class="number">0x5c</span>) inRegex = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">      c === <span class="number">0x7c</span> &amp;&amp; <span class="comment">// pipe, 0x7c =&gt; |</span></span><br><span class="line">      exp.charCodeAt(i + <span class="number">1</span>) !== <span class="number">0x7c</span> &amp;&amp;</span><br><span class="line">      exp.charCodeAt(i - <span class="number">1</span>) !== <span class="number">0x7c</span> &amp;&amp;</span><br><span class="line">      !curly &amp;&amp;</span><br><span class="line">      !square &amp;&amp;</span><br><span class="line">      !paren</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// 如果是遇到的第一个 |</span></span><br><span class="line">      <span class="keyword">if</span> (expression === <span class="literal">undefined</span>) &#123;</span><br><span class="line">        <span class="comment">// first filter, end of expression</span></span><br><span class="line">        lastFilterIndex = i + <span class="number">1</span>;</span><br><span class="line">        expression = exp.slice(<span class="number">0</span>, i).trim(); <span class="comment">// | 前面的表达式</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        pushFilter(); <span class="comment">// 将前一个filter推入filters栈</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 此前一直是普通文本，在这里判断是不是某些特殊字符，如 (</span></span><br><span class="line">      <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x22</span>:</span><br><span class="line">          inDouble = <span class="literal">true</span>;</span><br><span class="line">          <span class="keyword">break</span>; <span class="comment">// "</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x27</span>:</span><br><span class="line">          inSingle = <span class="literal">true</span>;</span><br><span class="line">          <span class="keyword">break</span>; <span class="comment">// '</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x60</span>:</span><br><span class="line">          inTemplateString = <span class="literal">true</span>;</span><br><span class="line">          <span class="keyword">break</span>; <span class="comment">// `</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x28</span>:</span><br><span class="line">          paren++;</span><br><span class="line">          <span class="keyword">break</span>; <span class="comment">// (</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x29</span>:</span><br><span class="line">          paren--;</span><br><span class="line">          <span class="keyword">break</span>; <span class="comment">// )</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x5b</span>:</span><br><span class="line">          square++;</span><br><span class="line">          <span class="keyword">break</span>; <span class="comment">// [</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x5d</span>:</span><br><span class="line">          square--;</span><br><span class="line">          <span class="keyword">break</span>; <span class="comment">// ]</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x7b</span>:</span><br><span class="line">          curly++;</span><br><span class="line">          <span class="keyword">break</span>; <span class="comment">// &#123;</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0x7d</span>:</span><br><span class="line">          curly--;</span><br><span class="line">          <span class="keyword">break</span>; <span class="comment">// &#125;</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 0x2f =&gt; / ,  判断是否当前位于正则表达式当中</span></span><br><span class="line">      <span class="keyword">if</span> (c === <span class="number">0x2f</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> j = i - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">let</span> p;</span><br><span class="line">        <span class="comment">// find first non-whitespace prev char</span></span><br><span class="line">        <span class="keyword">for</span> (; j &gt;= <span class="number">0</span>; j--) &#123;</span><br><span class="line">          p = exp.charAt(j);</span><br><span class="line">          <span class="keyword">if</span> (p !== <span class="string">' '</span>) <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!p || !validDivisionCharRE.test(p)) &#123;</span><br><span class="line">          inRegex = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (expression === <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="comment">// 如果始终没有|，那么整个入参都当做expression。</span></span><br><span class="line">    expression = exp.slice(<span class="number">0</span>, i).trim();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lastFilterIndex !== <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 如果之前在某个位置遇到了一个|，那么从那里到exp末尾都是这个filter</span></span><br><span class="line">    pushFilter();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">pushFilter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    (filters || (filters = [])).push(exp.slice(lastFilterIndex, i).trim());</span><br><span class="line">    lastFilterIndex = i + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// exp = "title|upper(123,456)|sense" =&gt; filters = ["upper(123,456)","sense"]</span></span><br><span class="line">  <span class="comment">// for循环后，expression = "_f("sense")(_f("upper")(title,123,456))"</span></span><br><span class="line">  <span class="keyword">if</span> (filters) &#123;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; filters.length; i++) &#123;</span><br><span class="line">      <span class="comment">// wrapFilter('title', 'upper') =&gt;   "_f("upper")(title)"</span></span><br><span class="line">      <span class="comment">// wrapFilter('title', 'upper(123,456)') =&gt; "_f("upper")(title,123,456)"</span></span><br><span class="line">      expression = wrapFilter(expression, filters[i]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> expression;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wrapFilter</span>(<span class="params">exp: string, filter: string</span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="comment">// filter的形式可以是 exp| filter，或者exp| filterName(filterArg)</span></span><br><span class="line">  <span class="keyword">const</span> i = filter.indexOf(<span class="string">'('</span>);</span><br><span class="line">  <span class="keyword">if</span> (i &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// _f: resolveFilter</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">`_f("<span class="subst">$&#123;filter&#125;</span>")(<span class="subst">$&#123;exp&#125;</span>)`</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> name = filter.slice(<span class="number">0</span>, i);</span><br><span class="line">    <span class="keyword">const</span> args = filter.slice(i + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`_f("<span class="subst">$&#123;name&#125;</span>")(<span class="subst">$&#123;exp&#125;</span><span class="subst">$&#123;args !== <span class="string">')'</span> ? <span class="string">','</span> + args : args&#125;</span>`</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数会将参数字符串按字符挨个处理，因为插值表达式的形式很多样，代码注释里有给出一些例子可以看看。</p>
<h2 id="起始标签"><a href="#起始标签" class="headerlink" title="起始标签"></a>起始标签</h2><p>在说完<code>while(html)</code>循环中的一些边界处理后，剩下的就是两个重头戏开始标签和结束标签了。</p>
<p><code>parseHTML</code>对这俩的处理有点类似<code>括号匹配</code>的做法，每当遇到起始标签时就把它放到一个堆栈里。在遇到一个结束标签时，通常此时的栈顶就是对应的起始标签。整个 html 的处理过程就随着入栈出栈的操作不断进行。等到处理完 html 之后，如果没错这个堆栈正好也会变成空的。</p>
<p>在<code>while(html)</code>循环中处理起始标签的代码很少，就是调用了 2 个函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Start tag起始标签，如&lt;p&gt;</span></span><br><span class="line">        <span class="keyword">const</span> startTagMatch = parseStartTag()</span><br><span class="line">        <span class="keyword">if</span> (startTagMatch) &#123;</span><br><span class="line">          handleStartTag(startTagMatch)</span><br><span class="line">          <span class="keyword">if</span> (shouldIgnoreFirstNewline(lastTag, html)) &#123;</span><br><span class="line">            advance(<span class="number">1</span>)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h2 id="parseStartTag"><a href="#parseStartTag" class="headerlink" title="parseStartTag"></a>parseStartTag</h2><p>解析起始标签，同时处理标签上的属性。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseStartTag</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// `&lt;div id="app"&gt;`.match(startTagOpen) =&gt;</span></span><br><span class="line">  <span class="comment">// ['&lt;div','div']</span></span><br><span class="line">  <span class="keyword">const</span> start = html.match(startTagOpen);</span><br><span class="line">  <span class="keyword">if</span> (start) &#123;</span><br><span class="line">    <span class="keyword">const</span> match = &#123;</span><br><span class="line">      tagName: start[<span class="number">1</span>],</span><br><span class="line">      attrs: [],</span><br><span class="line">      start: index,</span><br><span class="line">    &#125;;</span><br><span class="line">    advance(start[<span class="number">0</span>].length);</span><br><span class="line">    <span class="keyword">let</span> end, attr;</span><br><span class="line">    <span class="comment">// 如果不是以结束标签开头，并且有html属性。</span></span><br><span class="line">    <span class="comment">// `id="app"&gt;`.match(attribute)  =&gt;</span></span><br><span class="line">    <span class="comment">// ['id="app"','id','=','app']</span></span><br><span class="line">    <span class="keyword">while</span> (!(end = html.match(startTagClose)) &amp;&amp; (attr = html.match(attribute))) &#123;</span><br><span class="line">      advance(attr[<span class="number">0</span>].length);</span><br><span class="line">      match.attrs.push(attr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ['&gt;','']</span></span><br><span class="line">    <span class="keyword">if</span> (end) &#123;</span><br><span class="line">      match.unarySlash = end[<span class="number">1</span>];</span><br><span class="line">      advance(end[<span class="number">0</span>].length);</span><br><span class="line">      match.end = index;</span><br><span class="line">      <span class="keyword">return</span> match;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>比如此时的<code>html</code>为</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span>xxxxxx<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>则返回结果为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   	  tagName: <span class="string">'div'</span>,</span><br><span class="line">        attrs: [</span><br><span class="line">          [<span class="string">'id="app"'</span>,<span class="string">'id'</span>,<span class="string">'='</span>,<span class="string">'app'</span>,<span class="literal">undefined</span>,<span class="literal">undefined</span>]</span><br><span class="line">        ],</span><br><span class="line">        start: <span class="number">0</span>,</span><br><span class="line">        end: <span class="number">14</span>,</span><br><span class="line">        unarySlash: <span class="string">""</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="handleStartTag"><a href="#handleStartTag" class="headerlink" title="handleStartTag"></a>handleStartTag</h2><p>主要是继续处理<code>parseStartTag</code>返回值的<code>attrs</code>属性，并最终调用<code>parse</code>中传入的<code>start</code>选项。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// match的格式就是上面的parseStartTag返回值</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleStartTag</span>(<span class="params">match</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> tagName = match.tagName;</span><br><span class="line">  <span class="keyword">const</span> unarySlash = match.unarySlash;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (expectHTML) &#123;</span><br><span class="line">    <span class="keyword">if</span> (lastTag === <span class="string">'p'</span> &amp;&amp; isNonPhrasingTag(tagName)) &#123;</span><br><span class="line">      parseEndTag(lastTag);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (canBeLeftOpenTag(tagName) &amp;&amp; lastTag === tagName) &#123;</span><br><span class="line">      parseEndTag(tagName);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// isUnaryTag是否为单标签元素，如&lt;img&gt;，所有单标签元素：</span></span><br><span class="line">  <span class="comment">// 'area,base,br,col,embed,frame,hr,img,input,isindex,keygen'</span></span><br><span class="line">  <span class="comment">// 'link,meta,param,source,track,wbr'</span></span><br><span class="line">  <span class="keyword">const</span> unary = isUnaryTag(tagName) || !!unarySlash;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> l = match.attrs.length;</span><br><span class="line">  <span class="keyword">const</span> attrs = <span class="keyword">new</span> <span class="built_in">Array</span>(l);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; l; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> args = match.attrs[i];</span><br><span class="line">    <span class="comment">// hackish work around FF bug https://bugzilla.mozilla.org/show_bug.cgi?id=369778</span></span><br><span class="line">    <span class="keyword">if</span> (IS_REGEX_CAPTURING_BROKEN &amp;&amp; args[<span class="number">0</span>].indexOf(<span class="string">'""'</span>) === <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (args[<span class="number">3</span>] === <span class="string">''</span>) &#123;</span><br><span class="line">        <span class="keyword">delete</span> args[<span class="number">3</span>];</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (args[<span class="number">4</span>] === <span class="string">''</span>) &#123;</span><br><span class="line">        <span class="keyword">delete</span> args[<span class="number">4</span>];</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (args[<span class="number">5</span>] === <span class="string">''</span>) &#123;</span><br><span class="line">        <span class="keyword">delete</span> args[<span class="number">5</span>];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// args格式： ['id="app"','id','=','app',undefined,undefined]</span></span><br><span class="line">    <span class="keyword">const</span> value = args[<span class="number">3</span>] || args[<span class="number">4</span>] || args[<span class="number">5</span>] || <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">const</span> shouldDecodeNewlines = tagName === <span class="string">'a'</span> &amp;&amp; args[<span class="number">1</span>] === <span class="string">'href'</span> ? options.shouldDecodeNewlinesForHref : options.shouldDecodeNewlines;</span><br><span class="line">    <span class="comment">// attrs格式 ： &#123;name:string, value:string&#125;[]</span></span><br><span class="line">    <span class="comment">// 如 [&#123;name:'id',value:'app'&#125;]</span></span><br><span class="line">    attrs[i] = &#123;</span><br><span class="line">      name: args[<span class="number">1</span>],</span><br><span class="line">      value: decodeAttr(value, shouldDecodeNewlines),</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果不是单标签元素，那么先把这个其实标签记到标签堆栈当中，当遇到对应的结束标签时再出栈.</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * stack格式示范：</span></span><br><span class="line"><span class="comment">   * [</span></span><br><span class="line"><span class="comment">   *  &#123;</span></span><br><span class="line"><span class="comment">   *    tag: 'div',</span></span><br><span class="line"><span class="comment">   *    lowerCasedTag: 'div',</span></span><br><span class="line"><span class="comment">   *    attrs: [ &#123;name:'id',value:'app'&#125; ]</span></span><br><span class="line"><span class="comment">   *  &#125;</span></span><br><span class="line"><span class="comment">   * ]</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">if</span> (!unary) &#123;</span><br><span class="line">    stack.push(&#123; <span class="attr">tag</span>: tagName, <span class="attr">lowerCasedTag</span>: tagName.toLowerCase(), <span class="attr">attrs</span>: attrs &#125;);</span><br><span class="line">    lastTag = tagName; <span class="comment">// 标记当前正处理到哪个标签</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (options.start) &#123;</span><br><span class="line">    <span class="comment">// 调用parse函数中的start选项</span></span><br><span class="line">    options.start(tagName, attrs, unary, match.start, match.end);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="options-start"><a href="#options-start" class="headerlink" title="options.start"></a>options.start</h3><p>这里的逻辑很多，核心逻辑是解析节点上的各种静态、动态绑定。<strong>在这里我们会生成 AST 节点。</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 参数示范</span></span><br><span class="line"> <span class="comment">// tag: 'div';  当前处理的起始标签</span></span><br><span class="line"> <span class="comment">// attrs: [ &#123;name:'id',value:'app'&#125; ] 起始标签上的属性</span></span><br><span class="line"> <span class="comment">// unary: false。 是否单标签元素</span></span><br><span class="line"> start (tag, attrs, unary) &#123;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * element格式示范：</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    *  &#123;</span></span><br><span class="line"><span class="comment">         "type": 1,</span></span><br><span class="line"><span class="comment">         "tag": "div",</span></span><br><span class="line"><span class="comment">         "attrsList": [</span></span><br><span class="line"><span class="comment">           &#123;</span></span><br><span class="line"><span class="comment">             "name": "id",</span></span><br><span class="line"><span class="comment">             "value": "app"</span></span><br><span class="line"><span class="comment">           &#125;</span></span><br><span class="line"><span class="comment">         ],</span></span><br><span class="line"><span class="comment">         "attrsMap": &#123;</span></span><br><span class="line"><span class="comment">           "id": "app"</span></span><br><span class="line"><span class="comment">         &#125;,</span></span><br><span class="line"><span class="comment">         "children": [],</span></span><br><span class="line"><span class="comment">         parent: undefined</span></span><br><span class="line"><span class="comment">    * &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">let</span> element: ASTElement = createASTElement(tag, attrs, currentParent)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">// apply pre-transforms。 例如v-model的预处理</span></span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; preTransforms.length; i++) &#123;</span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * 目前只在model这个module中有定义，</span></span><br><span class="line"><span class="comment">      * 见src/platforms/web/compiler/modules/model.js，是专门用来预处理&lt;input v-model="xxx" type="xxx"&gt; 的。</span></span><br><span class="line"><span class="comment">      *</span></span><br><span class="line"><span class="comment">      * Expand input[v-model] with dyanmic type bindings into v-if-else chains</span></span><br><span class="line"><span class="comment">      * Turn this:</span></span><br><span class="line"><span class="comment">      *   &lt;input v-model="data[type]" :type="type"&gt;</span></span><br><span class="line"><span class="comment">      * into this:</span></span><br><span class="line"><span class="comment">      *   &lt;input v-if="type === 'checkbox'" type="checkbox" v-model="data[type]"&gt;</span></span><br><span class="line"><span class="comment">      *   &lt;input v-else-if="type === 'radio'" type="radio" v-model="data[type]"&gt;</span></span><br><span class="line"><span class="comment">      *   &lt;input v-else :type="type" v-model="data[type]"&gt;</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">     element = preTransforms[i](element, options) || element</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 处理v-pre指令, 如&lt;span v-pre&gt;&#123;&#123; this will not be compiled &#125;&#125;&lt;/span&gt;</span></span><br><span class="line">   <span class="comment">// 若有，则element.pre=true</span></span><br><span class="line">   <span class="keyword">if</span> (!inVPre) &#123;</span><br><span class="line">     processPre(element)</span><br><span class="line">     <span class="keyword">if</span> (element.pre) &#123;</span><br><span class="line">       inVPre = <span class="literal">true</span></span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (platformIsPreTag(element.tag)) &#123;</span><br><span class="line">     inPre = <span class="literal">true</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (inVPre) &#123;</span><br><span class="line">     processRawAttrs(element)</span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!element.processed) &#123;</span><br><span class="line">     <span class="comment">// structural directives</span></span><br><span class="line">     processFor(element) <span class="comment">// 处理节点上的v-for属性</span></span><br><span class="line">     processIf(element) <span class="comment">// 处理节点上的v-if属性</span></span><br><span class="line">     <span class="comment">// v-once只渲染元素和组件一次。随后的重新渲染，元素/组件及其所有的子节点将被视为静态内容并跳过。这可以用于优化更新性能。</span></span><br><span class="line">     processOnce(element) <span class="comment">// 处理节点上的v-once属性</span></span><br><span class="line">     <span class="comment">// element-scope stuff</span></span><br><span class="line">     processElement(element, options) <span class="comment">// 处理ref、slot、is、指令以及其他所有普通属性</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// tree management</span></span><br><span class="line">   <span class="keyword">if</span> (!root) &#123;</span><br><span class="line">     root = element</span><br><span class="line">     checkRootConstraints(root) <span class="comment">// 不能用slot和template当做root节点，同时root节点上不能有v-for</span></span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!stack.length) &#123;</span><br><span class="line">     <span class="comment">// allow root elements with v-if, v-else-if and v-else</span></span><br><span class="line">     <span class="comment">// 组件的根节点并不只是限制一个节点，而是可以由一组v-if, v-else-if and v-else节点</span></span><br><span class="line">     <span class="keyword">if</span> (root.if &amp;&amp; (element.elseif || element.else)) &#123;</span><br><span class="line">       checkRootConstraints(element)</span><br><span class="line">       addIfCondition(root, &#123;</span><br><span class="line">         exp: element.elseif,</span><br><span class="line">         block: element</span><br><span class="line">       &#125;)</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (currentParent &amp;&amp; !element.forbidden) &#123;</span><br><span class="line">     <span class="comment">// 在处理到v-else-if and v-else节点时，需要将其和v-if节点结合起来，</span></span><br><span class="line">     <span class="comment">// 通过在v-if节点上的ifConditions数组，来最终决定渲染哪个节点</span></span><br><span class="line">     <span class="keyword">if</span> (element.elseif || element.else) &#123;</span><br><span class="line">       processIfConditions(element, currentParent)</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (element.slotScope) &#123;</span><br><span class="line">       <span class="comment">// scoped slot，见processElement -&gt; processSlot</span></span><br><span class="line">       currentParent.plain = <span class="literal">false</span></span><br><span class="line">       <span class="keyword">const</span> name = element.slotTarget || <span class="string">'"default"'</span></span><br><span class="line">       ;(currentParent.scopedSlots || (currentParent.scopedSlots = &#123;&#125;))[name] = element</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       currentParent.children.push(element)</span><br><span class="line">       element.parent = currentParent</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// 如果当前处理的元素不是单标签元素，那么随后处理的element的父节点应该都是当前元素，</span></span><br><span class="line">   <span class="comment">// 直到处理到一个结束标签时，才会尝试再次修改currentParent</span></span><br><span class="line">   <span class="keyword">if</span> (!unary) &#123;</span><br><span class="line">     currentParent = element</span><br><span class="line">     stack.push(element) <span class="comment">// 保存所有处理到的标签路径，联想一下括号匹配</span></span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     closeElement(element) <span class="comment">// 单标签元素可以直接“关闭”当前元素，开启全新的下一轮</span></span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h4 id="AST-节点"><a href="#AST-节点" class="headerlink" title="AST 节点"></a>AST 节点</h4><p><code>createASTElement</code>用来创建一个 AST 节点，看看长什么样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createASTElement</span>(<span class="params">tag: string, attrs: Array&lt;Attr&gt;, parent: ASTElement | void</span>): <span class="title">ASTElement</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    type: <span class="number">1</span>,</span><br><span class="line">    tag,</span><br><span class="line">    attrsList: attrs,</span><br><span class="line">    attrsMap: makeAttrsMap(attrs),</span><br><span class="line">    parent,</span><br><span class="line">    children: [],</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很简单的几个属性，意义也很容易猜出来。不过<code>parse</code>的过程中可能一些 AST 节点上会添加各种其他属性。</p>
<h4 id="preTransforms"><a href="#preTransforms" class="headerlink" title="preTransforms"></a>preTransforms</h4><p>目前只有针对<code>v-model</code>的处理，这块逻辑有点多，不过代码比较简单，看注释即可。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">preTransformNode</span>(<span class="params">el: ASTElement, options: CompilerOptions</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (el.tag === <span class="string">'input'</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> map = el.attrsMap;</span><br><span class="line">    <span class="keyword">if</span> (!map[<span class="string">'v-model'</span>]) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> typeBinding;</span><br><span class="line">    <span class="comment">// 获取动态绑定的type属性</span></span><br><span class="line">    <span class="keyword">if</span> (map[<span class="string">':type'</span>] || map[<span class="string">'v-bind:type'</span>]) &#123;</span><br><span class="line">      typeBinding = getBindingAttr(el, <span class="string">'type'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!map.type &amp;&amp; !typeBinding &amp;&amp; map[<span class="string">'v-bind'</span>]) &#123;</span><br><span class="line">      typeBinding = <span class="string">`(<span class="subst">$&#123;map[<span class="string">'v-bind'</span>]&#125;</span>).type`</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (typeBinding) &#123;</span><br><span class="line">      <span class="keyword">const</span> ifCondition = getAndRemoveAttr(el, <span class="string">'v-if'</span>, <span class="literal">true</span>);</span><br><span class="line">      <span class="keyword">const</span> ifConditionExtra = ifCondition ? <span class="string">`&amp;&amp;(<span class="subst">$&#123;ifCondition&#125;</span>)`</span> : <span class="string">``</span>;</span><br><span class="line">      <span class="keyword">const</span> hasElse = getAndRemoveAttr(el, <span class="string">'v-else'</span>, <span class="literal">true</span>) != <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">const</span> elseIfCondition = getAndRemoveAttr(el, <span class="string">'v-else-if'</span>, <span class="literal">true</span>);</span><br><span class="line">      <span class="comment">// 1. checkbox</span></span><br><span class="line">      <span class="keyword">const</span> branch0 = cloneASTElement(el);</span><br><span class="line">      <span class="comment">// process for on the main node</span></span><br><span class="line">      processFor(branch0);</span><br><span class="line">      addRawAttr(branch0, <span class="string">'type'</span>, <span class="string">'checkbox'</span>);</span><br><span class="line">      processElement(branch0, options);</span><br><span class="line">      branch0.processed = <span class="literal">true</span>; <span class="comment">// prevent it from double-processed</span></span><br><span class="line">      branch0.if = <span class="string">`(<span class="subst">$&#123;typeBinding&#125;</span>)==='checkbox'`</span> + ifConditionExtra;</span><br><span class="line">      <span class="comment">// 若el对应的节点为：&lt;input :type="'checkbox'" v-model="msg"&gt;</span></span><br><span class="line">      <span class="comment">// 则 typeBinding="checkbox"； ifConditionExtra=“”，addIfCondition之后在el上增加的相关属性有</span></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * &#123;</span></span><br><span class="line"><span class="comment">       *    if: "('checkbox')==='checkbox'",</span></span><br><span class="line"><span class="comment">       *    attrsList: [</span></span><br><span class="line"><span class="comment">       *        // ...</span></span><br><span class="line"><span class="comment">       *        &#123;</span></span><br><span class="line"><span class="comment">       *          name: "type",</span></span><br><span class="line"><span class="comment">                  value: "checkbox"</span></span><br><span class="line"><span class="comment">       *        &#125;</span></span><br><span class="line"><span class="comment">       *    ],</span></span><br><span class="line"><span class="comment">       *    ifConditions:[</span></span><br><span class="line"><span class="comment">       *      &#123;</span></span><br><span class="line"><span class="comment">       *        block: branch0,</span></span><br><span class="line"><span class="comment">       *        exp: "('checkbox')==='checkbox'",</span></span><br><span class="line"><span class="comment">       *      &#125;</span></span><br><span class="line"><span class="comment">       *    ]</span></span><br><span class="line"><span class="comment">       * &#125;</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      addIfCondition(branch0, &#123;</span><br><span class="line">        exp: branch0.if,</span><br><span class="line">        block: branch0,</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="comment">// 2. add radio else-if condition</span></span><br><span class="line">      <span class="keyword">const</span> branch1 = cloneASTElement(el);</span><br><span class="line">      getAndRemoveAttr(branch1, <span class="string">'v-for'</span>, <span class="literal">true</span>);</span><br><span class="line">      addRawAttr(branch1, <span class="string">'type'</span>, <span class="string">'radio'</span>);</span><br><span class="line">      processElement(branch1, options);</span><br><span class="line">      addIfCondition(branch0, &#123;</span><br><span class="line">        exp: <span class="string">`(<span class="subst">$&#123;typeBinding&#125;</span>)==='radio'`</span> + ifConditionExtra,</span><br><span class="line">        block: branch1,</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="comment">// 3. other</span></span><br><span class="line">      <span class="keyword">const</span> branch2 = cloneASTElement(el);</span><br><span class="line">      getAndRemoveAttr(branch2, <span class="string">'v-for'</span>, <span class="literal">true</span>);</span><br><span class="line">      addRawAttr(branch2, <span class="string">':type'</span>, typeBinding);</span><br><span class="line">      processElement(branch2, options);</span><br><span class="line">      addIfCondition(branch0, &#123;</span><br><span class="line">        exp: ifCondition,</span><br><span class="line">        block: branch2,</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (hasElse) &#123;</span><br><span class="line">        branch0.else = <span class="literal">true</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (elseIfCondition) &#123;</span><br><span class="line">        branch0.elseif = elseIfCondition;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> branch0;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="processPre"><a href="#processPre" class="headerlink" title="processPre"></a>processPre</h4><p>处理<code>v-pre</code>指令, 如<code>&lt;span v-pre&gt;\{\{ this will not be compiled \}\}&lt;/span&gt;</code>, 若节点上有<code>v-pre</code>，则<code>el.pre=true</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">processPre</span>(<span class="params">el</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (getAndRemoveAttr(el, <span class="string">'v-pre'</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">    el.pre = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="processRawAttrs"><a href="#processRawAttrs" class="headerlink" title="processRawAttrs"></a>processRawAttrs</h4><p>处理 AST 节点上的<code>attrsList</code>属性，将他们复制到<code>attrs</code>上去。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">processRawAttrs</span>(<span class="params">el</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> l = el.attrsList.length;</span><br><span class="line">  <span class="keyword">if</span> (l) &#123;</span><br><span class="line">    <span class="keyword">const</span> attrs = (el.attrs = <span class="keyword">new</span> <span class="built_in">Array</span>(l));</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; l; i++) &#123;</span><br><span class="line">      attrs[i] = &#123;</span><br><span class="line">        name: el.attrsList[i].name,</span><br><span class="line">        value: <span class="built_in">JSON</span>.stringify(el.attrsList[i].value),</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!el.pre) &#123;</span><br><span class="line">    <span class="comment">// non root node in pre blocks with no attributes</span></span><br><span class="line">    el.plain = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="processFor"><a href="#processFor" class="headerlink" title="processFor"></a>processFor</h4><p>处理<code>v-for</code>，例如处理的起始标签为<code>&lt;div v-for=&quot;(value,key,index) in items&quot;&gt;</code>，那么此时传入的<code>el</code>为</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">     attrsList:[],</span><br><span class="line">     attrsMap: &#123;</span><br><span class="line">       v-<span class="keyword">for</span>: <span class="string">"(value,key,index) in items"</span></span><br><span class="line">     &#125;,</span><br><span class="line">     children: [],</span><br><span class="line">     tag: <span class="string">"div"</span>,</span><br><span class="line">      type: <span class="number">1</span>,</span><br><span class="line">      parent: ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">processFor</span>(<span class="params">el: ASTElement</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> exp;</span><br><span class="line">  <span class="comment">// getAndRemoveAttr:</span></span><br><span class="line">  <span class="comment">// 从attrsMap中获取key为‘v-for’的属性值，例如 "(value,key,index) in items"</span></span><br><span class="line">  <span class="keyword">if</span> ((exp = getAndRemoveAttr(el, <span class="string">'v-for'</span>))) &#123;</span><br><span class="line">    <span class="keyword">const</span> res = parseFor(exp);</span><br><span class="line">    <span class="keyword">if</span> (res) &#123;</span><br><span class="line">      extend(el, res);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      warn(<span class="string">`Invalid v-for expression: <span class="subst">$&#123;exp&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>parseFor</code>来拆解<code>v-for</code>表达式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">parseFor</span>(<span class="params">exp: string</span>): ?<span class="title">ForParseResult</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 若exp为(value,key,index)， inMatch为</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * [</span></span><br><span class="line"><span class="comment">   *    "(value,key,index) in items",</span></span><br><span class="line"><span class="comment">        "(value,key,index)",</span></span><br><span class="line"><span class="comment">        "items"</span></span><br><span class="line"><span class="comment">   * ]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">const</span> inMatch = exp.match(forAliasRE);</span><br><span class="line">  <span class="keyword">if</span> (!inMatch) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">const</span> res = &#123;&#125;;</span><br><span class="line">  res.for = inMatch[<span class="number">2</span>].trim();</span><br><span class="line">  <span class="comment">// 去掉两边括号，结果为‘value,key,index’</span></span><br><span class="line">  <span class="keyword">const</span> alias = inMatch[<span class="number">1</span>].trim().replace(stripParensRE, <span class="string">''</span>);</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * iteratorMatch示范</span></span><br><span class="line"><span class="comment">   * [</span></span><br><span class="line"><span class="comment">   *    ",key,index",</span></span><br><span class="line"><span class="comment">        "key",</span></span><br><span class="line"><span class="comment">        "index"</span></span><br><span class="line"><span class="comment">   * ]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">const</span> iteratorMatch = alias.match(forIteratorRE);</span><br><span class="line">  <span class="keyword">if</span> (iteratorMatch) &#123;</span><br><span class="line">    res.alias = alias.replace(forIteratorRE, <span class="string">''</span>); <span class="comment">// 'value'</span></span><br><span class="line">    res.iterator1 = iteratorMatch[<span class="number">1</span>].trim(); <span class="comment">// 'key'</span></span><br><span class="line">    <span class="keyword">if</span> (iteratorMatch[<span class="number">2</span>]) &#123;</span><br><span class="line">      res.iterator2 = iteratorMatch[<span class="number">2</span>].trim(); <span class="comment">// 'index'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res.alias = alias; <span class="comment">// ‘value,key,index’</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>若<code>v-for</code>属性值为<code>‘(value,key,index) in items’</code>,<code>parseFor</code>处理后在<code>ast</code>上添加的属性有：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="keyword">for</span>: <span class="string">'items'</span>,</span><br><span class="line">  alias: <span class="string">'value'</span>,</span><br><span class="line">  iterator1: <span class="string">'key'</span></span><br><span class="line">  iterator2: <span class="string">'index'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="processIf"><a href="#processIf" class="headerlink" title="processIf"></a>processIf</h4><p>对于<code>v-if, v-else-if和 v-else</code>，实际上在不同阶段都有对应处理，主要是因为它可以有多个分支，最终渲染哪个分支需要根据绑定的值来决定，所以比较复杂。</p>
<p><strong>1. processIf</strong></p>
<p>处理节点上的 v-if 属性。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">processIf</span>(<span class="params">el</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> exp = getAndRemoveAttr(el, <span class="string">'v-if'</span>);</span><br><span class="line">  <span class="keyword">if</span> (exp) &#123;</span><br><span class="line">    el.if = exp; <span class="comment">// 'condition'</span></span><br><span class="line">    <span class="comment">// 往el.ifConditions数组添加&#123;exp，block&#125;</span></span><br><span class="line">    addIfCondition(el, &#123;</span><br><span class="line">      exp: exp,</span><br><span class="line">      block: el,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (getAndRemoveAttr(el, <span class="string">'v-else'</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">      el.else = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> elseif = getAndRemoveAttr(el, <span class="string">'v-else-if'</span>);</span><br><span class="line">    <span class="keyword">if</span> (elseif) &#123;</span><br><span class="line">      el.elseif = elseif; <span class="comment">// "condition2"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>若 html 为</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">v-if</span>=<span class="string">"condition"</span>&gt;</span>this is v-if<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">v-else-if</span>=<span class="string">"condition2"</span>&gt;</span>this is v-else-if<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">v-else</span>&gt;</span>this is v-else<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>则<code>processIf</code>会调用 3 次，每次的差别在于<code>attrsMap</code>里的属性值</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   attrsList:[],</span><br><span class="line">   attrsMap: &#123;</span><br><span class="line">      <span class="string">'v-if'</span>: <span class="string">'condition'</span></span><br><span class="line">      <span class="comment">// 或者 'v-else-if': "condition2"</span></span><br><span class="line">      <span class="comment">// 或者 'v-else': ""</span></span><br><span class="line">   &#125;,</span><br><span class="line">   tag: <span class="string">'div'</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>2. 在处理到<code>v-else-if and v-else</code>节点时, 需要将其和 v-if 节点结合起来：</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (currentParent &amp;&amp; !element.forbidden) &#123;</span><br><span class="line">  <span class="comment">// 通过在v-if节点上的ifConditions数组，来最终决定渲染哪个节点</span></span><br><span class="line">  <span class="keyword">if</span> (element.elseif || element.else) &#123;</span><br><span class="line">    processIfConditions(element, currentParent);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>processIfConditions</code>用于将<code>v-else-if或v-else</code>上绑定的表达式都统一放到<code>v-if</code>节点上的<code>ifConditions</code>数组数组中。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">processIfConditions</span>(<span class="params">el, parent</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> prev = findPrevElement(parent.children); <span class="comment">// 找到v-else-if或v-else前面的v-if节点</span></span><br><span class="line">  <span class="keyword">if</span> (prev &amp;&amp; prev.if) &#123;</span><br><span class="line">    <span class="comment">// 添加prev.ifConditions数组元素</span></span><br><span class="line">    addIfCondition(prev, &#123;</span><br><span class="line">      exp: el.elseif,</span><br><span class="line">      block: el,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    warn(<span class="string">`v-<span class="subst">$&#123;el.elseif ? <span class="string">'else-if="'</span> + el.elseif + <span class="string">'"'</span> : <span class="string">'else'</span>&#125;</span> `</span> + <span class="string">`used on element &lt;<span class="subst">$&#123;el.tag&#125;</span>&gt; without corresponding v-if.`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 找到children中第一个element节点</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findPrevElement</span>(<span class="params">children: Array&lt;any&gt;</span>): <span class="title">ASTElement</span> | <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> i = children.length;</span><br><span class="line">  <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">    <span class="keyword">if</span> (children[i].type === <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> children[i];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; children[i].text !== <span class="string">' '</span>) &#123;</span><br><span class="line">        warn(<span class="string">`text "<span class="subst">$&#123;children[i].text.trim()&#125;</span>" between v-if and v-else(-if) `</span> + <span class="string">`will be ignored.`</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      children.pop();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终会在<code>v-if</code>标签节点对应<code>AST</code>的<code>ifConditions</code>数组中存放了所有的可能分支，这个数组的格式为</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	exp: string,</span><br><span class="line"> 		block: ASTElement</span><br><span class="line">&#125;[]</span><br></pre></td></tr></table></figure>
<p>在<code>render</code>时会找到 exp 成立的那个元素，渲染对应的<code>block</code>。</p>
<h4 id="processOnce"><a href="#processOnce" class="headerlink" title="processOnce"></a>processOnce</h4><p>处理<code>v-once</code>，这个指令只渲染元素和组件一次。随后的重新渲染，元素/组件及其所有的子节点将被视为静态内容并跳过。这可以用于优化更新性能。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">processOnce</span>(<span class="params">el</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> once = getAndRemoveAttr(el, <span class="string">'v-once'</span>);</span><br><span class="line">  <span class="keyword">if</span> (once != <span class="literal">null</span>) &#123;</span><br><span class="line">    el.once = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="processElement"><a href="#processElement" class="headerlink" title="processElement"></a>processElement</h4><p>处理<code>ref</code>、<code>slot</code>、<code>is</code>、<code>指令</code>以及其他所有普通属性.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">processElement</span>(<span class="params">element: ASTElement, options: CompilerOptions</span>) </span>&#123;</span><br><span class="line">  processKey(element); <span class="comment">// 处理静态或动态key属性</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// determine whether this is a plain element after</span></span><br><span class="line">  <span class="comment">// removing structural attributes</span></span><br><span class="line">  <span class="comment">// 纯元素：没有key属性以及其他任何属性</span></span><br><span class="line">  element.plain = !element.key &amp;&amp; !element.attrsList.length;</span><br><span class="line"></span><br><span class="line">  processRef(element); <span class="comment">// 处理静态或动态ref属性</span></span><br><span class="line">  processSlot(element); <span class="comment">// 处理slot，获取slotTarget和slotScope属性</span></span><br><span class="line">  processComponent(element); <span class="comment">// 处理is属性，将对应值设置到component属性上</span></span><br><span class="line">  <span class="comment">// 处理class、style module的transformNode</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; transforms.length; i++) &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * transforms目前只在class和style的module中有定义，逻辑类似</span></span><br><span class="line"><span class="comment">     * 见src/platforms/web/compiler/modules文件夹。</span></span><br><span class="line"><span class="comment">     * 其中</span></span><br><span class="line"><span class="comment">     * 1. class的transforms作用：</span></span><br><span class="line"><span class="comment">     *   a. 获取静态绑定的class属性，放到el.staticClass</span></span><br><span class="line"><span class="comment">     *   b. 获取动态绑定的class属性，放到el.classBinding</span></span><br><span class="line"><span class="comment">     * 2. style的transforms作用：</span></span><br><span class="line"><span class="comment">     *  a. 获取静态绑定的style属性，放到el.staticStyle</span></span><br><span class="line"><span class="comment">     *  b. 获取动态绑定的style属性，放到el.styleBinding</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    element = transforms[i](element, options) || element;</span><br><span class="line">  &#125;</span><br><span class="line">  processAttrs(element); <span class="comment">// 处理element上的所有属性，根据属性名分为指令和普通属性</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>内部调用了多个其他函数，挨个来说是做什么的。</p>
<h4 id="processKey"><a href="#processKey" class="headerlink" title="processKey"></a>processKey</h4><p>获取静态或动态绑定的<code>key</code>属性.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">processKey</span>(<span class="params">el</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 获取动态绑定的key属性</span></span><br><span class="line">  <span class="keyword">const</span> exp = getBindingAttr(el, <span class="string">'key'</span>);</span><br><span class="line">  <span class="keyword">if</span> (exp) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    el.key = exp;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getBindingAttr</span>(<span class="params">el: ASTElement, name: string, getStatic?: boolean</span>): ?<span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> dynamicValue = getAndRemoveAttr(el, <span class="string">':'</span> + name) || getAndRemoveAttr(el, <span class="string">'v-bind:'</span> + name);</span><br><span class="line">  <span class="keyword">if</span> (dynamicValue != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> parseFilters(dynamicValue);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getStatic !== <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> staticValue = getAndRemoveAttr(el, name);</span><br><span class="line">    <span class="keyword">if</span> (staticValue != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">JSON</span>.stringify(staticValue);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="processRef"><a href="#processRef" class="headerlink" title="processRef"></a>processRef</h4><p>获取动态绑定的<code>ref</code>属性，并检查是否位于<code>v-for</code>当中。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">processRef</span>(<span class="params">el</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ref = getBindingAttr(el, <span class="string">'ref'</span>);</span><br><span class="line">  <span class="keyword">if</span> (ref) &#123;</span><br><span class="line">    el.ref = ref;</span><br><span class="line">    el.refInFor = checkInFor(el);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 并检查是否位于`v-for`当中</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkInFor</span>(<span class="params">el: ASTElement</span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> parent = el;</span><br><span class="line">  <span class="keyword">while</span> (parent) &#123;</span><br><span class="line">    <span class="keyword">if</span> (parent.for !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    parent = parent.parent;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="processSlot"><a href="#processSlot" class="headerlink" title="processSlot"></a>processSlot</h4><p>处理<code>slot</code>插槽, 插槽有 3 种形式：</p>
<ol>
<li>定义插槽： <code>&lt;slot name=&#39;xxx&#39;&gt;</code> 或 <code>&lt;slot&gt;</code></li>
<li>作用域插槽： <code>&lt;template slot-scope=&quot;slotScope&quot;&gt;&lt;/template&gt;</code>. 在定义插槽时绑定在<code>slot</code>元素上的值会传递给<code>slotScope</code></li>
<li>使用插槽: <code>&lt;p slot=&quot;xxx&quot;&gt;&lt;/p&gt;</code></li>
</ol>
<p><strong>1. 处理插槽和作用域插槽,获取 slotName、slotScope、slotTarget</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">processSlot</span>(<span class="params">el</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// &lt;slot name='xxx'&gt;</span></span><br><span class="line">  <span class="keyword">if</span> (el.tag === <span class="string">'slot'</span>) &#123;</span><br><span class="line">    el.slotName = getBindingAttr(el, <span class="string">'name'</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> slotScope;</span><br><span class="line">    <span class="comment">// 整个if/else-if分支用于获取作用域插槽的绑定值slotScope</span></span><br><span class="line">    <span class="keyword">if</span> (el.tag === <span class="string">'template'</span>) &#123;</span><br><span class="line">      <span class="comment">// &lt;template scope="xxx"&gt;</span></span><br><span class="line">      slotScope = getAndRemoveAttr(el, <span class="string">'scope'</span>);</span><br><span class="line">      <span class="comment">// &lt;template slot-scope="xxx"&gt;</span></span><br><span class="line">      el.slotScope = slotScope || getAndRemoveAttr(el, <span class="string">'slot-scope'</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((slotScope = getAndRemoveAttr(el, <span class="string">'slot-scope'</span>))) &#123;</span><br><span class="line">      <span class="comment">// 普通元素上的作用域插槽，如 &lt;p slot-scope="xxx"&gt;123&lt;/p&gt;</span></span><br><span class="line">      el.slotScope = slotScope;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// &lt;p slot="xxx"&gt;&lt;/p&gt;</span></span><br><span class="line">    <span class="keyword">const</span> slotTarget = getBindingAttr(el, <span class="string">'slot'</span>);</span><br><span class="line">    <span class="keyword">if</span> (slotTarget) &#123;</span><br><span class="line">      el.slotTarget = slotTarget === <span class="string">'""'</span> ? <span class="string">'"default"'</span> : slotTarget;</span><br><span class="line">      <span class="comment">// preserve slot as an attribute for native shadow DOM compat</span></span><br><span class="line">      <span class="comment">// only for non-scoped slots.</span></span><br><span class="line">      <span class="keyword">if</span> (el.tag !== <span class="string">'template'</span> &amp;&amp; !el.slotScope) &#123;</span><br><span class="line">        addAttr(el, <span class="string">'slot'</span>, slotTarget);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>2. 生成 scopedSlots 映射</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (currentParent &amp;&amp; !element.forbidden) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (element.slotScope) &#123;</span><br><span class="line">          <span class="comment">// scoped slot，见processElement -&gt; processSlot</span></span><br><span class="line">          currentParent.plain = <span class="literal">false</span></span><br><span class="line">          <span class="keyword">const</span> name = element.slotTarget || <span class="string">'"default"'</span></span><br><span class="line">          ;(currentParent.scopedSlots || (currentParent.scopedSlots = &#123;&#125;))[name] = element</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<h4 id="processComponent"><a href="#processComponent" class="headerlink" title="processComponent"></a>processComponent</h4><p>处理<code>is</code>属性，将对应值设置到<code>component</code>属性上.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">processComponent</span>(<span class="params">el</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> binding;</span><br><span class="line">  <span class="keyword">if</span> ((binding = getBindingAttr(el, <span class="string">'is'</span>))) &#123;</span><br><span class="line">    el.component = binding;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (getAndRemoveAttr(el, <span class="string">'inline-template'</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">    el.inlineTemplate = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="transforms"><a href="#transforms" class="headerlink" title="transforms"></a>transforms</h4><p><code>v-model</code>的<code>preTransform</code>是在<code>processElement</code>之前执行，而<code>class</code>和<code>style</code>的处理是在<code>processElement</code>之内处理的，而且处理方法很类似。</p>
<p><code>transforms</code>目前只在<code>class</code>和<code>style</code>的<code>module</code>中有定义，见<code>src/platforms/web/compiler/modules</code>文件夹。<br>其中</p>
<ol>
<li><code>class</code>的<code>transforms</code>作用：<ol>
<li>获取静态绑定的<code>class</code>属性，放到<code>el.staticClass</code></li>
<li>获取动态绑定的<code>class</code>属性，放到<code>el.classBinding</code></li>
</ol>
</li>
<li><code>style</code>的<code>transforms</code>作用：<ol>
<li>获取静态绑定的<code>style</code>属性，放到<code>el.staticStyle</code></li>
<li>获取动态绑定的<code>style</code>属性，放到<code>el.styleBinding</code></li>
</ol>
</li>
</ol>
<p>这里只展示<code>class</code>的源码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">transformNode</span>(<span class="params">el: ASTElement, options: CompilerOptions</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> warn = options.warn || baseWarn;</span><br><span class="line">  <span class="keyword">const</span> staticClass = getAndRemoveAttr(el, <span class="string">'class'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// warning略去...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (staticClass) &#123;</span><br><span class="line">    el.staticClass = <span class="built_in">JSON</span>.stringify(staticClass);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> classBinding = getBindingAttr(el, <span class="string">'class'</span>, <span class="literal">false</span> <span class="comment">/* getStatic */</span>);</span><br><span class="line">  <span class="keyword">if</span> (classBinding) &#123;</span><br><span class="line">    el.classBinding = classBinding;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="processAttrs"><a href="#processAttrs" class="headerlink" title="processAttrs"></a>processAttrs</h4><p>处理<code>element</code>上的所有属性，根据属性名分为指令和普通属性,<code>v-on</code>的处理也会在这里。</p>
<p>对于动态绑定属性的处理会比较复杂，静态绑定很简单。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">processAttrs</span>(<span class="params">el</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// attrsList结构示范：[&#123;name:'id',value:'app'&#125;]</span></span><br><span class="line">  <span class="keyword">const</span> list = el.attrsList;</span><br><span class="line">  <span class="keyword">let</span> i, l, name, rawName, value, modifiers, isProp;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>, l = list.length; i &lt; l; i++) &#123;</span><br><span class="line">    name = rawName = list[i].name;</span><br><span class="line">    value = list[i].value;</span><br><span class="line">    <span class="comment">// v- 或 @ 或 : 开头的属性名</span></span><br><span class="line">    <span class="keyword">if</span> (dirRE.test(name)) &#123;</span><br><span class="line">      <span class="comment">// 处理动态绑定...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// literal attribute， 非动态绑定的普通属性</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// warning略去</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 往el.attrs上添加元素,attrs的结构与attrsList相同</span></span><br><span class="line">      addAttr(el, name, <span class="built_in">JSON</span>.stringify(value));</span><br><span class="line">      <span class="comment">// #6887 firefox doesn't update muted state if set via attribute</span></span><br><span class="line">      <span class="comment">// even immediately after element creation</span></span><br><span class="line">      <span class="keyword">if</span> (!el.component &amp;&amp; name === <span class="string">'muted'</span> &amp;&amp; platformMustUseProp(el.tag, el.attrsMap.type, name)) &#123;</span><br><span class="line">        addProp(el, name, <span class="string">'true'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的<code>if (dirRE.test(name))</code>分支就是用来处理动态绑定的属性，是匹配<code>v-</code> 或 <code>@</code> 或 <code>:</code> 开头的属性名. 相比之下静态属性就是简单的调用<code>addAttr</code>放到<code>el.attrs</code>即可。</p>
<p>动态绑定属性的分支代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mark element as dynamic</span></span><br><span class="line">el.hasBindings = <span class="literal">true</span>;</span><br><span class="line"><span class="comment">// modifiers修饰符， 即.xxx，若存在则返回一个对象， &#123;m1: true, m2:true&#125;</span></span><br><span class="line">modifiers = parseModifiers(name);</span><br><span class="line"><span class="keyword">if</span> (modifiers) &#123;</span><br><span class="line">  name = name.replace(modifierRE, <span class="string">''</span>); <span class="comment">// 去除修饰符</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (bindRE.test(name)) &#123;</span><br><span class="line">  <span class="comment">// v-bind，: 或 v-bind: 开头的属性绑定</span></span><br><span class="line">  name = name.replace(bindRE, <span class="string">''</span>); <span class="comment">// 去掉: 或 v-bind:</span></span><br><span class="line">  value = parseFilters(value); <span class="comment">// 解析可能的过滤器，若存在则返回的value是一个字符串</span></span><br><span class="line">  isProp = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (modifiers) &#123;</span><br><span class="line">    <span class="comment">// 见v-bind api: https://cn.vuejs.org/v2/api/#v-bind</span></span><br><span class="line">    <span class="comment">// .prop修饰符：被用于绑定 DOM 属性 (property)</span></span><br><span class="line">    <span class="keyword">if</span> (modifiers.prop) &#123;</span><br><span class="line">      isProp = <span class="literal">true</span>;</span><br><span class="line">      name = camelize(name);</span><br><span class="line">      <span class="keyword">if</span> (name === <span class="string">'innerHtml'</span>) name = <span class="string">'innerHTML'</span>; <span class="comment">// innerHtml.prop</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// .camel - (2.1.0+) 将 kebab-case 特性名转换为 camelCase</span></span><br><span class="line">    <span class="keyword">if</span> (modifiers.camel) &#123;</span><br><span class="line">      name = camelize(name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// .sync (2.3.0+) 语法糖，会扩展成一个更新父组件绑定值的 v-on 侦听器。</span></span><br><span class="line">    <span class="keyword">if</span> (modifiers.sync) &#123;</span><br><span class="line">      addHandler(el, <span class="string">`update:<span class="subst">$&#123;camelize(name)&#125;</span>`</span>, genAssignmentCode(value, <span class="string">`$event`</span>)); <span class="comment">// 添加事件监听</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isProp || (!el.component &amp;&amp; platformMustUseProp(el.tag, el.attrsMap.type, name))) &#123;</span><br><span class="line">    addProp(el, name, value);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// attrs只存在动态绑定的属性，如[&#123;name: "href"，value: 'xxx'&#125;]</span></span><br><span class="line">    <span class="comment">// attrsList存在的是大杂烩，存在所有动态/静态属性</span></span><br><span class="line">    <span class="comment">//      [&#123;name: ":href"，value: 'xxx'&#125;,</span></span><br><span class="line">    <span class="comment">//      &#123;name: "target", value: "_blank"&#125;,</span></span><br><span class="line">    <span class="comment">//      &#123;name: "@click.native", value: "log"&#125;]</span></span><br><span class="line">    addAttr(el, name, value); <span class="comment">// 将去除修饰符之后的属性添加到el.attrs数组</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (onRE.test(name)) &#123;</span><br><span class="line">  <span class="comment">// v-on，事件绑定</span></span><br><span class="line">  name = name.replace(onRE, <span class="string">''</span>);</span><br><span class="line">  <span class="comment">// 添加事件监听,处理el.nativeEvents或el.events对象，他们的格式为</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * &#123;</span></span><br><span class="line"><span class="comment">   *    [eventName]: handler | handler[],</span></span><br><span class="line"><span class="comment">   * &#125;，</span></span><br><span class="line"><span class="comment">   * handler格式</span></span><br><span class="line"><span class="comment">   * &#123;</span></span><br><span class="line"><span class="comment">   *    value: string,</span></span><br><span class="line"><span class="comment">   *    modifiers: &#123; [name: string]: true &#125;</span></span><br><span class="line"><span class="comment">   * &#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  addHandler(el, name, value, modifiers, <span class="literal">false</span>, warn);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// normal directives，普通指令， v-xxx</span></span><br><span class="line">  name = name.replace(dirRE, <span class="string">''</span>);</span><br><span class="line">  <span class="comment">// parse arg，解析指令参数</span></span><br><span class="line">  <span class="keyword">const</span> argMatch = name.match(argRE);</span><br><span class="line">  <span class="keyword">const</span> arg = argMatch &amp;&amp; argMatch[<span class="number">1</span>];</span><br><span class="line">  <span class="keyword">if</span> (arg) &#123;</span><br><span class="line">    name = name.slice(<span class="number">0</span>, -(arg.length + <span class="number">1</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 添加el.directives数组元素</span></span><br><span class="line">  <span class="comment">// el.directives.push(&#123; name, rawName, value, arg, modifiers &#125;)</span></span><br><span class="line">  addDirective(el, name, rawName, value, arg, modifiers);</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; name === <span class="string">'model'</span>) &#123;</span><br><span class="line">    checkForAliasModel(el, value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>v-bind</code>的修饰符有 3 种，<code>prop</code>、<code>camel</code>和<code>sync</code>，官网上的解释很清楚，可以自己去看下。</p>
<p>其他注释已经很清楚了，需要再看看的是其中调用的一些帮助函数，挨个说下。</p>
<h5 id="parseModifiers"><a href="#parseModifiers" class="headerlink" title="parseModifiers"></a>parseModifiers</h5><p>获取绑定的修饰符，注意不仅仅是<a href="mailto:`@event.m1.m2" target="_blank" rel="noopener">`@event.m1.m2</a><code>可以加修饰符，</code>:prop.m1.m2`也是可以加的哦~</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseModifiers</span>(<span class="params">name: string</span>): <span class="title">Object</span> | <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> match = name.match(modifierRE); <span class="comment">// /\.[^.]+/g // .xxx</span></span><br><span class="line">  <span class="keyword">if</span> (match) &#123;</span><br><span class="line">    <span class="keyword">const</span> ret = &#123;&#125;;</span><br><span class="line">    match.forEach(<span class="function"><span class="params">m</span> =&gt;</span> &#123;</span><br><span class="line">      ret[m.slice(<span class="number">1</span>)] = <span class="literal">true</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>若存在修饰符则返回一个对象，类似<code>{m1: true, m2:true}</code>.</p>
<h5 id="addHandler"><a href="#addHandler" class="headerlink" title="addHandler"></a>addHandler</h5><p>添加事件监听,处理<code>el.nativeEvents</code>或<code>el.events</code>对象.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">addHandler</span>(<span class="params">el: ASTElement, name: string, value: string, modifiers: ?ASTModifiers, important?: boolean, warn?: Function</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// modifiers事件修饰符对象，如&#123; native: true &#125;</span></span><br><span class="line">  modifiers = modifiers || emptyObject;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// check capture modifier</span></span><br><span class="line">  <span class="keyword">if</span> (modifiers.capture) &#123;</span><br><span class="line">    <span class="keyword">delete</span> modifiers.capture;</span><br><span class="line">    name = <span class="string">'!'</span> + name; <span class="comment">// mark the event as captured</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (modifiers.once) &#123;</span><br><span class="line">    <span class="keyword">delete</span> modifiers.once;</span><br><span class="line">    name = <span class="string">'~'</span> + name; <span class="comment">// mark the event as once</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">  <span class="keyword">if</span> (modifiers.passive) &#123;</span><br><span class="line">    <span class="keyword">delete</span> modifiers.passive;</span><br><span class="line">    name = <span class="string">'&amp;'</span> + name; <span class="comment">// mark the event as passive</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// normalize click.right and click.middle since they don't actually fire</span></span><br><span class="line">  <span class="comment">// this is technically browser-specific, but at least for now browsers are</span></span><br><span class="line">  <span class="comment">// the only target envs that have right/middle clicks.</span></span><br><span class="line">  <span class="keyword">if</span> (name === <span class="string">'click'</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (modifiers.right) &#123;</span><br><span class="line">      name = <span class="string">'contextmenu'</span>; <span class="comment">// 将click.right修改为contextmenu事件</span></span><br><span class="line">      <span class="keyword">delete</span> modifiers.right;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (modifiers.middle) &#123;</span><br><span class="line">      name = <span class="string">'mouseup'</span>; <span class="comment">// 将click.middle修改为mouseup事件</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> events; <span class="comment">// 容纳所有事件处理器的包装对象</span></span><br><span class="line">  <span class="keyword">if</span> (modifiers.native) &#123;</span><br><span class="line">    <span class="keyword">delete</span> modifiers.native;</span><br><span class="line">    events = el.nativeEvents || (el.nativeEvents = &#123;&#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    events = el.events || (el.events = &#123;&#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> newHandler: any = &#123;</span><br><span class="line">    value: value.trim(),</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 除了上述列举的修饰符，还有其他修饰符</span></span><br><span class="line">  <span class="keyword">if</span> (modifiers !== emptyObject) &#123;</span><br><span class="line">    newHandler.modifiers = modifiers;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> handlers = events[name];</span><br><span class="line">  <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(handlers)) &#123;</span><br><span class="line">    <span class="comment">// 在el上已有多个对此事件的处理器，将所有处理器放到一个数组里</span></span><br><span class="line">    important ? handlers.unshift(newHandler) : handlers.push(newHandler);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (handlers) &#123;</span><br><span class="line">    <span class="comment">// 在el上已有1个对此事件的处理器</span></span><br><span class="line">    events[name] = important ? [newHandler, handlers] : [handlers, newHandler];</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 在el上还没有对此事件的处理器</span></span><br><span class="line">    events[name] = newHandler;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  el.plain = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终<code>el.nativeEvents</code>或<code>el.events</code>对象，他们的格式为</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> &#123;</span><br><span class="line">   [eventName]: handler | handler[],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>handler 格式</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   value: string,</span><br><span class="line">   modifiers: &#123; [name: string]: <span class="literal">true</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>针对不同的内置修饰符，<code>eventName</code>的格式有所不同，如<code>name.once</code>会变成 <code>~name</code>.</p>
<h1 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h1><p>可以看到整个流程涉及的东西非常多，很容易蒙圈。最好的办法就是写一个小 demo，然后逐步打断点看看每一步的结果。例如：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">  这里是文本</span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-for</span>=<span class="string">"(value,key,index) in items"</span>&gt;</span>&#123;&#123;item&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-if</span>=<span class="string">"condition"</span>&gt;</span>this is v-if<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-else-if</span>=<span class="string">"condition2"</span>&gt;</span>this is v-else-if<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-else</span>&gt;</span>this is v-else<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span> <span class="attr">v-once</span>&gt;</span>This will never change in v-once: &#123;&#123;msg&#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">:type</span>=<span class="string">"'checkbox'"</span> <span class="attr">v-model</span>=<span class="string">"msg"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">:href</span>=<span class="string">"url"</span> <span class="attr">v-loading</span>=<span class="string">"true"</span> @<span class="attr">click.native</span>=<span class="string">"log"</span> @<span class="attr">change</span>=<span class="string">"log"</span> <span class="attr">target</span>=<span class="string">"_blank"</span>&gt;</span>前面的文本&#123;&#123;title|upper(123,456)|sense&#125;&#125;后面的文本<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">:src</span>=<span class="string">"img"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(<span class="number">123</span>);</span></span><br><span class="line"><span class="undefined">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">  <span class="keyword">var</span> vm = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">    el: <span class="string">'#app'</span>,</span></span><br><span class="line"><span class="undefined">    data: &#123;</span></span><br><span class="line"><span class="javascript">      url: <span class="string">'https://www.baidu.com'</span>,</span></span><br><span class="line"><span class="javascript">      title: <span class="string">'liubin'</span>,</span></span><br><span class="line"><span class="javascript">      img: <span class="string">'https://test.jpg'</span>,</span></span><br><span class="line"><span class="undefined">      items: [&#123; a: 1, b: 2, c: 3 &#125;],</span></span><br><span class="line"><span class="javascript">      condition: <span class="literal">false</span>,</span></span><br><span class="line"><span class="javascript">      condition2: <span class="literal">false</span>,</span></span><br><span class="line"><span class="javascript">      msg: <span class="string">'12345'</span>,</span></span><br><span class="line"><span class="undefined">    &#125;,</span></span><br><span class="line"><span class="undefined">    filters: &#123;</span></span><br><span class="line"><span class="undefined">      upper(value) &#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> value.toUpperCase();</span></span><br><span class="line"><span class="undefined">      &#125;,</span></span><br><span class="line"><span class="undefined">    &#125;,</span></span><br><span class="line"><span class="undefined">    methods: &#123;</span></span><br><span class="line"><span class="undefined">      log() &#123;&#125;,</span></span><br><span class="line"><span class="undefined">    &#125;,</span></span><br><span class="line"><span class="undefined">  &#125;);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>最后生成的 AST 为：</p>
<p><img src="/images/vue-source-code/parse/ast-1.png" alt=""><br><img src="/images/vue-source-code/parse/ast-2.png" alt=""></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Vue/" rel="tag"># Vue</a>
          
            <a href="/tags/javascript/" rel="tag"># javascript</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/10/20/vue-sourcecode-4-observer-dep-watcher/" rel="next" title="Vue源码解析4-双向数据绑定">
                <i class="fa fa-chevron-left"></i> Vue源码解析4-双向数据绑定
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/10/31/vscode-experience/" rel="prev" title="vscode使用经验">
                vscode使用经验 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        <!-- Go to www.addthis.com/dashboard to customize your tools -->
<div class="addthis_inline_share_toolbox">
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5c2f329e843996fd" async="async"></script>
</div>

      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1544633647623&di=9344c3068a2e155434bd39899d7cd25d&imgtype=0&src=http%3A%2F%2Fpic65.nipic.com%2Ffile%2F20150428%2F12641788_080744824000_2.jpg" alt="Liu Bin">
            
              <p class="site-author-name" itemprop="name">Liu Bin</p>
              <p class="site-description motion-element" itemprop="description">码畜</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">79</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">62</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#入口"><span class="nav-number">1.</span> <span class="nav-text">入口</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#parseHTML"><span class="nav-number">2.</span> <span class="nav-text">parseHTML</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#while-html"><span class="nav-number">2.1.</span> <span class="nav-text">while (html)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#正则表达式"><span class="nav-number">2.1.1.</span> <span class="nav-text">正则表达式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#options-comment"><span class="nav-number">2.1.2.</span> <span class="nav-text">options.comment</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#options-chars"><span class="nav-number">2.1.3.</span> <span class="nav-text">options.chars</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#parseText"><span class="nav-number">2.1.4.</span> <span class="nav-text">parseText</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#parseFilters"><span class="nav-number">2.1.5.</span> <span class="nav-text">parseFilters</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#起始标签"><span class="nav-number">2.2.</span> <span class="nav-text">起始标签</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#parseStartTag"><span class="nav-number">2.3.</span> <span class="nav-text">parseStartTag</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#handleStartTag"><span class="nav-number">2.4.</span> <span class="nav-text">handleStartTag</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#options-start"><span class="nav-number">2.4.1.</span> <span class="nav-text">options.start</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#AST-节点"><span class="nav-number">2.4.1.1.</span> <span class="nav-text">AST 节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#preTransforms"><span class="nav-number">2.4.1.2.</span> <span class="nav-text">preTransforms</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#processPre"><span class="nav-number">2.4.1.3.</span> <span class="nav-text">processPre</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#processRawAttrs"><span class="nav-number">2.4.1.4.</span> <span class="nav-text">processRawAttrs</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#processFor"><span class="nav-number">2.4.1.5.</span> <span class="nav-text">processFor</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#processIf"><span class="nav-number">2.4.1.6.</span> <span class="nav-text">processIf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#processOnce"><span class="nav-number">2.4.1.7.</span> <span class="nav-text">processOnce</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#processElement"><span class="nav-number">2.4.1.8.</span> <span class="nav-text">processElement</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#processKey"><span class="nav-number">2.4.1.9.</span> <span class="nav-text">processKey</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#processRef"><span class="nav-number">2.4.1.10.</span> <span class="nav-text">processRef</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#processSlot"><span class="nav-number">2.4.1.11.</span> <span class="nav-text">processSlot</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#processComponent"><span class="nav-number">2.4.1.12.</span> <span class="nav-text">processComponent</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#transforms"><span class="nav-number">2.4.1.13.</span> <span class="nav-text">transforms</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#processAttrs"><span class="nav-number">2.4.1.14.</span> <span class="nav-text">processAttrs</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#parseModifiers"><span class="nav-number">2.4.1.14.1.</span> <span class="nav-text">parseModifiers</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#addHandler"><span class="nav-number">2.4.1.14.2.</span> <span class="nav-text">addHandler</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#实验"><span class="nav-number">3.</span> <span class="nav-text">实验</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Liu Bin</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        
<div class="busuanzi-count">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      本站访客数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人次
    </span>
  

  
    <span class="site-pv">
      本站总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://orangeeeee.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'https://hellogithub2014.github.io/2018/10/27/vue-sourcecode-5-template-parse/';
          this.page.identifier = '2018/10/27/vue-sourcecode-5-template-parse/';
          this.page.title = 'Vue源码解析5-模板解析parse';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://orangeeeee.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  














  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.4"></script>



  

  

  

  
  

  

  

  

</body>
</html>
